var FS, Path, $, Client, TreeView, AddDialog, MoveDialog;

function hasProject() {
	return atom.project && atom.project.getPaths().length;
}

module.exports = {
	configDefaults: {
		hideLocalWhenDisplayed: false
	},

	treeView: null,
	client: null,

	activate: function activate(state) {
		var self = this;

		if (!FS) {
			FS = require('fs-plus');
			Path = require('path');
			$ = require('atom').$;

			Client = require('./client');
			TreeView = require('./views/tree-view');
			Directory = require('./directory');
		}

		atom.project.remoteftp = new Client();

		self.treeView = new TreeView();
		self.treeView.detach();

		atom.project.remoteftp.on('connected', function () {
			self.treeView.root.name.attr('data-name', Path.basename(atom.project.remoteftp.root.remote));
			self.treeView.root.name.attr('data-path', atom.project.remoteftp.root.remote);
		});

		if (hasProject() && atom.project.resolve('.ftpconfig')) {
			FS.exists(atom.project.resolve('.ftpconfig'), function (exists) {
				if (exists) self.treeView.attach();
			});
		}

		atom.commands.add('atom-workspace', {

			'remote-ftp:create-ftp-config': function remoteFtpCreateFtpConfig() {
				if (!hasProject()) return;

				FS.writeFile(atom.project.resolve('.ftpconfig'), '{\n    "protocol": "ftp",\n\t"host": "example.com",\n    "port": 21,\n    "user": "user",\n    "pass": "pass",\n    "remote": "/",\n    "secure": false,\n    "secureOptions": null,\n    "connTimeout": 10000,\n    "pasvTimeout": 10000,\n    "keepalive": 10000\n}', function (err) {
					if (!err) atom.workspace.open(atom.project.resolve('.ftpconfig'));
				});
			},

			'remote-ftp:create-sftp-config': function remoteFtpCreateSftpConfig() {
				if (!hasProject()) return;

				FS.writeFile(atom.project.resolve('.ftpconfig'), '{\n    "protocol": "sftp",\n\t"host": "example.com",\n    "port": 22,\n    "user": "user",\n    "pass": "pass",\n    "remote": "/",\n\t"agent": "",\n    "privatekey": "",\n\t"passphrase": "",\n\t"hosthash": "",\n\t"ignorehost": true,\n\t"connTimeout": 10000,\n\t"keepalive": 10000\n}', function (err) {
					if (!err) atom.workspace.open(atom.project.resolve('.ftpconfig'));
				});
			},

			'remote-ftp:toggle': function remoteFtpToggle() {
				if (!hasProject()) return;

				self.treeView.toggle();
			},

			'remote-ftp:connect': function remoteFtpConnect() {
				if (!hasProject()) return;

				atom.project.remoteftp.readConfig(function (e) {
					if (e) {
						throw 'Could not read `.ftpconfig` file';
						return;
					}

					if (!self.treeView.isVisible()) {
						self.treeView.toggle();
					}

					atom.project.remoteftp.connect();
				});
			},

			'remote-ftp:disconnect': function remoteFtpDisconnect() {
				if (!hasProject()) return;

				atom.project.remoteftp.disconnect();
			},

			'remote-ftp:add-file': function remoteFtpAddFile() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				if (!AddDialog) AddDialog = require('./dialogs/add-dialog');

				var dialog = new AddDialog('');
				dialog.on('new-path', function (e, name) {
					dialog.close();

					var remote = Path.join(remotes[0].item.remote, name).replace(/\\/g, '/');

					atom.project.remoteftp.mkdir(remotes[0].item.remote, true, function (err) {
						atom.project.remoteftp.mkfile(remote, function (err) {

							remotes[0].open();

							if (!err) atom.workspace.open(atom.project.remoteftp.toLocal(remote));
						});
					});
				});
				dialog.attach();
			},

			'remote-ftp:add-folder': function remoteFtpAddFolder() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				if (!AddDialog) AddDialog = require('./dialogs/add-dialog');

				var dialog = new AddDialog('');
				dialog.on('new-path', function (e, name) {
					var remote = Path.join(remotes[0].item.remote, name).replace(/\\/g, '/');

					atom.project.remoteftp.mkdir(remote, true, function (err) {
						dialog.close();

						remotes[0].open();
					});
				});
				dialog.attach();
			},

			'remote-ftp:refresh-selected': function remoteFtpRefreshSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				remotes.forEach(function (remote) {
					remote.open();
				});
			},

			'remote-ftp:move-selected': function remoteFtpMoveSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				if (!MoveDialog) MoveDialog = require('./dialogs/move-dialog');

				var dialog = new MoveDialog(remotes[0].item.remote);
				dialog.on('path-changed', function (e, newremote) {
					atom.project.remoteftp.rename(remotes[0].item.remote, newremote, function (error) {
						dialog.close();

						// Refresh new folder
						var parentNew = self.treeView.resolve(Path.dirname(newremote));
						if (parentNew) parentNew.open();

						// Refresh old folder
						var parentOld = self.treeView.resolve(Path.dirname(remotes[0].item.remote));
						if (parentOld && parentOld != parentNew) parentOld.open();

						remotes[0].destroy();
					});
				});
				dialog.attach();
			},

			'remote-ftp:delete-selected': function remoteFtpDeleteSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				atom.confirm({
					message: 'Are you sure you want to delete the selected item?',
					detailedMessage: 'You are deleting:' + remotes.map(function (view) {
						return '\n  ' + view.item.remote;
					}),
					buttons: {
						'Move to Trash': function MoveToTrash() {
							remotes.forEach(function (view) {
								if (!view) return;

								var dir = Path.dirname(view.item.remote).replace(/\\/g, '/'),
								    parent = self.treeView.resolve(dir);

								atom.project.remoteftp['delete'](view.item.remote, function (err, list) {
									if (!err && parent) {
										parent.open();
									}
								});
							});
						},
						'Cancel': null
					}
				});
			},

			'remote-ftp:download-selected': function remoteFtpDownloadSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				remotes.forEach(function (view) {
					if (!view) return;

					atom.project.remoteftp.download(view.item.remote, true, function (err) {});
				});
			},

			'remote-ftp:upload-selected': function remoteFtpUploadSelected() {
				if (!hasProject()) return;

				var locals = $('.tree-view .selected').map(function () {
					return this.getPath ? this.getPath() : '';
				}).get();

				locals.forEach(function (local) {
					if (!local) return;

					atom.project.remoteftp.upload(local, function (err, list) {
						if (err) return;

						var dirs = [];
						list.forEach(function (item) {
							var remote = atom.project.remoteftp.toRemote(item.name),
							    dir = Path.dirname(remote);
							if (dirs.indexOf(dir) == -1) dirs.push(dir);
						});

						dirs.forEach(function (dir) {
							var view = self.treeView.resolve(dir);

							if (view) view.open();
						});
					});
				});
			},

			// Remote -> local
			'remote-ftp:sync-with-remote': function remoteFtpSyncWithRemote() {
				var remotes = self.treeView.getSelected();

				remotes.forEach(function (view) {
					if (!view) return;

					atom.project.remoteftp.syncRemoteLocal(view.item.remote, function (err) {});
				});
			},

			// Local -> Remote
			'remote-ftp:sync-with-local': function remoteFtpSyncWithLocal() {
				if (!hasProject()) return;

				var locals = $('.tree-view .selected').map(function () {
					return this.getPath ? this.getPath() : '';
				}).get();

				locals.forEach(function (local) {
					if (!local) return;

					atom.project.remoteftp.syncLocalRemote(local, function (err) {
						var remote = atom.project.remoteftp.toRemote(local);
						if (remote) {
							var parent = self.treeView.resolve(remote);
							if (!(parent.item instanceof Directory)) parent = self.treeView.resolve(Path.dirname(remote).replace(/\\/g, '/'));

							if (parent) parent.open();
						}
					});
				});
			},

			'remote-ftp:abort-current': function remoteFtpAbortCurrent() {
				if (!hasProject()) return;

				atom.project.remoteftp.abort();
			},

			'remote-ftp:navigate-to': function remoteFtpNavigateTo() {
				if (!hasProject()) return;

				if (!AddDialog) AddDialog = require('./dialogs/navigate-to-dialog');

				var dialog = new NavigateTo();
				dialog.on('navigate-to', function (e, path) {
					dialog.close();

					atom.project.remoteftp.root.openPath(path);
				});
				dialog.attach();
			}
		});

		atom.workspace.eachEditor(function (ed) {
			var buffer = ed.buffer;
			buffer.on('saved', self.fileSaved.bind(self));
		});
	},

	deactivate: function deactivate() {
		var self = this;
		atom.workspace.eachEditor(function (ed) {
			var buffer = ed.buffer;
			buffer.off('saved', self.fileSaved);
		});

		if (atom.project.remoteftp) atom.project.remoteftp.disconnect();
	},

	fileSaved: function fileSaved(text) {
		if (!hasProject()) return;

		var self = this;

		//if (!atom.project.remoteftp.isConnected())
		//	return;

		var local = text.file.path;

		if (!atom.project.contains(local)) return;

		if (local == atom.project.resolve('.ftpconfig')) return;

		atom.project.remoteftp.upload(local, function (err) {
			try {
				var remote = atom.project.remoteftp.toRemote(local),
				    parent = atom.project.remoteftp.resolve(Path.dirname(remote).replace(/\\/g, '/'));
				if (parent) parent.open();
			} catch (e) {}
		});
	}
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9uYXZlci8uYXRvbS9wYWNrYWdlcy9yZW1vdGUtZnRwL2xpYi9yZW1vdGUtZnRwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDOztBQUV6RCxTQUFTLFVBQVUsR0FBSTtBQUN0QixRQUFPLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxNQUFNLENBQUM7Q0FDdEQ7O0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNoQixlQUFjLEVBQUU7QUFDZix3QkFBc0IsRUFBRSxLQUFLO0VBQzdCOztBQUVELFNBQVEsRUFBRSxJQUFJO0FBQ2QsT0FBTSxFQUFFLElBQUk7O0FBRVosU0FBUSxFQUFFLGtCQUFVLEtBQUssRUFBRTtBQUMxQixNQUFJLElBQUksR0FBRyxJQUFJLENBQUM7O0FBRWhCLE1BQUksQ0FBQyxFQUFFLEVBQUU7QUFDUixLQUFFLEdBQUcsT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3hCLE9BQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDdkIsSUFBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7O0FBRXRCLFNBQU0sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDN0IsV0FBUSxHQUFHLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO0FBQ3hDLFlBQVMsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDLENBQUM7R0FDbkM7O0FBRUQsTUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQzs7QUFFdEMsTUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLFFBQVEsRUFBRSxDQUFDO0FBQy9CLE1BQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7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LENBQUMsQ0FBQyxPQUFPLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7QUFDbkYsUUFBSSxNQUFNLEVBQ1QsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2YsQ0FBQyxPQUFPLENBQUMsRUFBRSxFQUFFO0dBQ2QsQ0FBQyxDQUFDO0VBQ0g7Q0FDRCxDQUFBIiwiZmlsZSI6Ii9Vc2Vycy9uYXZlci8uYXRvbS9wYWNrYWdlcy9yZW1vdGUtZnRwL2xpYi9yZW1vdGUtZnRwLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIEZTLCBQYXRoLCAkLCBDbGllbnQsIFRyZWVWaWV3LCBBZGREaWFsb2csIE1vdmVEaWFsb2c7XG5cbmZ1bmN0aW9uIGhhc1Byb2plY3QgKCkge1xuXHRyZXR1cm4gYXRvbS5wcm9qZWN0ICYmIGF0b20ucHJvamVjdC5nZXRQYXRocygpLmxlbmd0aDtcbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7XG5cdGNvbmZpZ0RlZmF1bHRzOiB7XG5cdFx0aGlkZUxvY2FsV2hlbkRpc3BsYXllZDogZmFsc2Vcblx0fSxcblxuXHR0cmVlVmlldzogbnVsbCxcblx0Y2xpZW50OiBudWxsLFxuXG5cdGFjdGl2YXRlOiBmdW5jdGlvbiAoc3RhdGUpIHtcblx0XHR2YXIgc2VsZiA9IHRoaXM7XG5cblx0XHRpZiAoIUZTKSB7XG5cdFx0XHRGUyA9IHJlcXVpcmUoJ2ZzLXBsdXMnKTtcblx0XHRcdFBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5cdFx0XHQkID0gcmVxdWlyZSgnYXRvbScpLiQ7XG5cblx0XHRcdENsaWVudCA9IHJlcXVpcmUoJy4vY2xpZW50Jyk7XG5cdFx0XHRUcmVlVmlldyA9IHJlcXVpcmUoJy4vdmlld3MvdHJlZS12aWV3Jyk7XG5cdFx0XHREaXJlY3RvcnkgPSByZXF1aXJlKCcuL2RpcmVjdG9yeScpO1xuXHRcdH1cblxuXHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAgPSBuZXcgQ2xpZW50KCk7XG5cblx0XHRzZWxmLnRyZWVWaWV3ID0gbmV3IFRyZWVWaWV3KCk7XG5cdFx0c2VsZi50cmVlVmlldy5kZXRhY2goKTtcblxuXHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAub24oJ2Nvbm5lY3RlZCcsIGZ1bmN0aW9uICgpIHtcblx0XHRcdHNlbGYudHJlZVZpZXcucm9vdC5uYW1lLmF0dHIoJ2RhdGEtbmFtZScsIFBhdGguYmFzZW5hbWUoYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5yb290LnJlbW90ZSkpO1xuXHRcdFx0c2VsZi50cmVlVmlldy5yb290Lm5hbWUuYXR0cignZGF0YS1wYXRoJywgYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5yb290LnJlbW90ZSk7XG5cdFx0fSk7XG5cblx0XHRpZiAoaGFzUHJvamVjdCgpICYmIGF0b20ucHJvamVjdC5yZXNvbHZlKCcuZnRwY29uZmlnJykpIHtcblx0XHRcdEZTLmV4aXN0cyhhdG9tLnByb2plY3QucmVzb2x2ZSgnLmZ0cGNvbmZpZycpLCBmdW5jdGlvbiAoZXhpc3RzKSB7XG5cdFx0XHRcdGlmIChleGlzdHMpXG5cdFx0XHRcdFx0c2VsZi50cmVlVmlldy5hdHRhY2goKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHtcblxuXHRcdFx0J3JlbW90ZS1mdHA6Y3JlYXRlLWZ0cC1jb25maWcnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0RlMud3JpdGVGaWxlKGF0b20ucHJvamVjdC5yZXNvbHZlKCcuZnRwY29uZmlnJyksICd7XFxuXFxcbiAgICBcInByb3RvY29sXCI6IFwiZnRwXCIsXFxuXFxcblx0XCJob3N0XCI6IFwiZXhhbXBsZS5jb21cIixcXG5cXFxuICAgIFwicG9ydFwiOiAyMSxcXG5cXFxuICAgIFwidXNlclwiOiBcInVzZXJcIixcXG5cXFxuICAgIFwicGFzc1wiOiBcInBhc3NcIixcXG5cXFxuICAgIFwicmVtb3RlXCI6IFwiL1wiLFxcblxcXG4gICAgXCJzZWN1cmVcIjogZmFsc2UsXFxuXFxcbiAgICBcInNlY3VyZU9wdGlvbnNcIjogbnVsbCxcXG5cXFxuICAgIFwiY29ublRpbWVvdXRcIjogMTAwMDAsXFxuXFxcbiAgICBcInBhc3ZUaW1lb3V0XCI6IDEwMDAwLFxcblxcXG4gICAgXCJrZWVwYWxpdmVcIjogMTAwMDBcXG5cXFxufSdcdFx0XHQsIGZ1bmN0aW9uIChlcnIpIHtcblx0XHRcdFx0XHRpZiAoIWVycilcblx0XHRcdFx0XHRcdGF0b20ud29ya3NwYWNlLm9wZW4oYXRvbS5wcm9qZWN0LnJlc29sdmUoJy5mdHBjb25maWcnKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6Y3JlYXRlLXNmdHAtY29uZmlnJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdEZTLndyaXRlRmlsZShhdG9tLnByb2plY3QucmVzb2x2ZSgnLmZ0cGNvbmZpZycpLCAne1xcblxcXG4gICAgXCJwcm90b2NvbFwiOiBcInNmdHBcIixcXG5cXFxuXHRcImhvc3RcIjogXCJleGFtcGxlLmNvbVwiLFxcblxcXG4gICAgXCJwb3J0XCI6IDIyLFxcblxcXG4gICAgXCJ1c2VyXCI6IFwidXNlclwiLFxcblxcXG4gICAgXCJwYXNzXCI6IFwicGFzc1wiLFxcblxcXG4gICAgXCJyZW1vdGVcIjogXCIvXCIsXFxuXFxcblx0XCJhZ2VudFwiOiBcIlwiLFxcblxcXG4gICAgXCJwcml2YXRla2V5XCI6IFwiXCIsXFxuXFxcblx0XCJwYXNzcGhyYXNlXCI6IFwiXCIsXFxuXFxcblx0XCJob3N0aGFzaFwiOiBcIlwiLFxcblxcXG5cdFwiaWdub3JlaG9zdFwiOiB0cnVlLFxcblxcXG5cdFwiY29ublRpbWVvdXRcIjogMTAwMDAsXFxuXFxcblx0XCJrZWVwYWxpdmVcIjogMTAwMDBcXG5cXFxufSdcdFx0XHQsIGZ1bmN0aW9uIChlcnIpIHtcblx0XHRcdFx0XHRpZiAoIWVycilcblx0XHRcdFx0XHRcdGF0b20ud29ya3NwYWNlLm9wZW4oYXRvbS5wcm9qZWN0LnJlc29sdmUoJy5mdHBjb25maWcnKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6dG9nZ2xlJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdCAgICAgICAgICAgIHNlbGYudHJlZVZpZXcudG9nZ2xlKCk7XG5cdCAgICAgICAgfSxcblxuXHQgICAgICAgICdyZW1vdGUtZnRwOmNvbm5lY3QnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0ICAgICAgICAgICAgYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5yZWFkQ29uZmlnKGZ1bmN0aW9uIChlKSB7XG5cdCAgICAgICAgICAgICAgICBpZiAoZSkge1xuXHRcdFx0XHRcdFx0dGhyb3cgXCJDb3VsZCBub3QgcmVhZCBgLmZ0cGNvbmZpZ2AgZmlsZVwiO1xuXHQgICAgICAgICAgICAgICAgICAgIHJldHVybjtcblx0ICAgICAgICAgICAgICAgIH1cblxuXHRcdFx0XHRcdGlmICghc2VsZi50cmVlVmlldy5pc1Zpc2libGUoKSkge1xuXHRcdFx0XHRcdFx0c2VsZi50cmVlVmlldy50b2dnbGUoKTtcblx0XHRcdFx0XHR9XG5cblx0ICAgICAgICAgICAgICAgIGF0b20ucHJvamVjdC5yZW1vdGVmdHAuY29ubmVjdCgpO1xuXHQgICAgICAgICAgICB9KTtcblx0ICAgICAgICB9LFxuXG5cdCAgICAgICAgJ3JlbW90ZS1mdHA6ZGlzY29ubmVjdCc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHQgICAgICAgICAgICBhdG9tLnByb2plY3QucmVtb3RlZnRwLmRpc2Nvbm5lY3QoKTtcblx0ICAgICAgICB9LFxuXG5cdCAgICAgICAgJ3JlbW90ZS1mdHA6YWRkLWZpbGUnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0ICAgICAgICAgICAgdmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cdFx0XHRcdGlmICghcmVtb3RlcyB8fCByZW1vdGVzLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHRcdFx0YXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiKipSZW1vdGUtRlRQKio8YnIgLz5Zb3UgbmVlZCB0byBzZWxlY3QgYSBmb2xkZXIgZmlyc3RcIik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0ICAgICAgICAgICAgaWYgKCFBZGREaWFsb2cpXG5cdCAgICAgICAgICAgICAgICBBZGREaWFsb2cgPSByZXF1aXJlKCcuL2RpYWxvZ3MvYWRkLWRpYWxvZycpO1xuXG5cdCAgICAgICAgICAgIHZhciBkaWFsb2cgPSBuZXcgQWRkRGlhbG9nKCcnKTtcblx0ICAgIFx0XHRkaWFsb2cub24oJ25ldy1wYXRoJywgZnVuY3Rpb24gKGUsIG5hbWUpIHtcblx0XHRcdFx0XHRkaWFsb2cuY2xvc2UoKTtcblxuXHQgICAgICAgICAgICAgICAgdmFyIHJlbW90ZSA9IFBhdGguam9pbihyZW1vdGVzWzBdLml0ZW0ucmVtb3RlLCBuYW1lKS5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cblx0ICAgICAgICAgICAgICAgIGF0b20ucHJvamVjdC5yZW1vdGVmdHAubWtkaXIocmVtb3Rlc1swXS5pdGVtLnJlbW90ZSwgdHJ1ZSwgZnVuY3Rpb24gKGVycikge1xuXHQgICAgICAgICAgICAgICAgICAgIGF0b20ucHJvamVjdC5yZW1vdGVmdHAubWtmaWxlKHJlbW90ZSwgZnVuY3Rpb24gKGVycikge1xuXG5cdCAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZXNbMF0ub3BlbigpO1xuXG5cdCAgICAgICAgICAgICAgICAgICAgICAgIGlmICghZXJyKVxuXHQgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXRvbS53b3Jrc3BhY2Uub3BlbihhdG9tLnByb2plY3QucmVtb3RlZnRwLnRvTG9jYWwocmVtb3RlKSk7XG5cdCAgICAgICAgICAgICAgICAgICAgfSlcblx0ICAgICAgICAgICAgICAgIH0pO1xuXHQgICAgXHRcdH0pO1xuXHQgICAgICAgICAgICBkaWFsb2cuYXR0YWNoKCk7XG5cdCAgICAgICAgfSxcblxuXHQgICAgICAgICdyZW1vdGUtZnRwOmFkZC1mb2xkZXInOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0ICAgICAgICAgICAgdmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cdFx0XHRcdGlmICghcmVtb3RlcyB8fCByZW1vdGVzLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHRcdFx0YXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiKipSZW1vdGUtRlRQKio8YnIgLz5Zb3UgbmVlZCB0byBzZWxlY3QgYSBmb2xkZXIgZmlyc3RcIik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0ICAgICAgICAgICAgaWYgKCFBZGREaWFsb2cpXG5cdCAgICAgICAgICAgICAgICBBZGREaWFsb2cgPSByZXF1aXJlKCcuL2RpYWxvZ3MvYWRkLWRpYWxvZycpO1xuXG5cdCAgICAgICAgICAgIHZhciBkaWFsb2cgPSBuZXcgQWRkRGlhbG9nKCcnKTtcblx0ICAgICAgICAgICAgZGlhbG9nLm9uKCduZXctcGF0aCcsIGZ1bmN0aW9uIChlLCBuYW1lKSB7XG5cdCAgICAgICAgICAgICAgICB2YXIgcmVtb3RlID0gUGF0aC5qb2luKHJlbW90ZXNbMF0uaXRlbS5yZW1vdGUsIG5hbWUpLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcblxuXHQgICAgICAgICAgICAgICAgYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5ta2RpcihyZW1vdGUsIHRydWUsIGZ1bmN0aW9uIChlcnIpIHtcblx0ICAgICAgICAgICAgICAgICAgICBkaWFsb2cuY2xvc2UoKTtcblxuXHQgICAgICAgICAgICAgICAgICAgIHJlbW90ZXNbMF0ub3BlbigpO1xuXHQgICAgICAgICAgICAgICAgfSlcblx0ICAgICAgICAgICAgfSk7XG5cdCAgICAgICAgICAgIGRpYWxvZy5hdHRhY2goKTtcblx0ICAgICAgICB9LFxuXG5cdCAgICAgICAgJ3JlbW90ZS1mdHA6cmVmcmVzaC1zZWxlY3RlZCc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHQgICAgICAgICAgICB2YXIgcmVtb3RlcyA9IHNlbGYudHJlZVZpZXcuZ2V0U2VsZWN0ZWQoKTtcblx0XHRcdFx0aWYgKCFyZW1vdGVzIHx8IHJlbW90ZXMubGVuZ3RoID09IDApIHtcblx0XHRcdFx0XHRhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCIqKlJlbW90ZS1GVFAqKjxiciAvPllvdSBuZWVkIHRvIHNlbGVjdCBhIGZvbGRlciBmaXJzdFwiKTtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHQgICAgICAgICAgICByZW1vdGVzLmZvckVhY2goZnVuY3Rpb24gKHJlbW90ZSkge1xuXHQgICAgICAgICAgICAgICAgcmVtb3RlLm9wZW4oKTtcblx0ICAgICAgICAgICAgfSk7XG5cdCAgICAgICAgfSxcblxuXHQgICAgICAgICdyZW1vdGUtZnRwOm1vdmUtc2VsZWN0ZWQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0ICAgICAgICAgICAgdmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cdFx0XHRcdGlmICghcmVtb3RlcyB8fCByZW1vdGVzLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHRcdFx0YXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiKipSZW1vdGUtRlRQKio8YnIgLz5Zb3UgbmVlZCB0byBzZWxlY3QgYSBmb2xkZXIgZmlyc3RcIik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0ICAgICAgICAgICAgaWYgKCFNb3ZlRGlhbG9nKVxuXHQgICAgICAgICAgICAgICAgTW92ZURpYWxvZyA9IHJlcXVpcmUoJy4vZGlhbG9ncy9tb3ZlLWRpYWxvZycpO1xuXG5cdCAgICAgICAgICAgIHZhciBkaWFsb2cgPSBuZXcgTW92ZURpYWxvZyhyZW1vdGVzWzBdLml0ZW0ucmVtb3RlKTtcblx0ICAgIFx0XHRkaWFsb2cub24oJ3BhdGgtY2hhbmdlZCcsIGZ1bmN0aW9uIChlLCBuZXdyZW1vdGUpIHtcblx0ICAgIFx0XHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAucmVuYW1lKHJlbW90ZXNbMF0uaXRlbS5yZW1vdGUsIG5ld3JlbW90ZSwgZnVuY3Rpb24gKGVycm9yKSB7XG5cdFx0XHRcdFx0XHRkaWFsb2cuY2xvc2UoKTtcblxuXHRcdFx0XHRcdFx0Ly8gUmVmcmVzaCBuZXcgZm9sZGVyXG5cdFx0XHRcdFx0XHR2YXIgcGFyZW50TmV3ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKFBhdGguZGlybmFtZShuZXdyZW1vdGUpKTtcblx0XHRcdFx0XHRcdGlmIChwYXJlbnROZXcpXG5cdFx0XHRcdFx0XHRcdHBhcmVudE5ldy5vcGVuKCk7XG5cblx0XHRcdFx0XHRcdC8vIFJlZnJlc2ggb2xkIGZvbGRlclxuXHRcdFx0XHRcdFx0dmFyIHBhcmVudE9sZCA9IHNlbGYudHJlZVZpZXcucmVzb2x2ZShQYXRoLmRpcm5hbWUocmVtb3Rlc1swXS5pdGVtLnJlbW90ZSkpO1xuXHRcdFx0XHRcdFx0aWYgKHBhcmVudE9sZCAmJiBwYXJlbnRPbGQgIT0gcGFyZW50TmV3KVxuXHRcdFx0XHRcdFx0XHRwYXJlbnRPbGQub3BlbigpO1xuXG5cdCAgICAgICAgICAgICAgICAgICAgcmVtb3Rlc1swXS5kZXN0cm95KCk7XG5cdCAgICBcdFx0XHR9KTtcblx0ICAgIFx0XHR9KTtcblx0ICAgIFx0XHRkaWFsb2cuYXR0YWNoKCk7XG5cdCAgICAgICAgfSxcblxuXHQgICAgICAgICdyZW1vdGUtZnRwOmRlbGV0ZS1zZWxlY3RlZCc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHQgICAgICAgICAgICB2YXIgcmVtb3RlcyA9IHNlbGYudHJlZVZpZXcuZ2V0U2VsZWN0ZWQoKTtcblx0XHRcdFx0aWYgKCFyZW1vdGVzIHx8IHJlbW90ZXMubGVuZ3RoID09IDApIHtcblx0XHRcdFx0XHRhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCIqKlJlbW90ZS1GVFAqKjxiciAvPllvdSBuZWVkIHRvIHNlbGVjdCBhIGZvbGRlciBmaXJzdFwiKTtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHQgICAgICAgICAgICBhdG9tLmNvbmZpcm0oe1xuXHQgICAgXHRcdFx0bWVzc2FnZTogXCJBcmUgeW91IHN1cmUgeW91IHdhbnQgdG8gZGVsZXRlIHRoZSBzZWxlY3RlZCBpdGVtP1wiLFxuXHQgICAgXHRcdFx0ZGV0YWlsZWRNZXNzYWdlOiBcIllvdSBhcmUgZGVsZXRpbmc6XCIrIHJlbW90ZXMubWFwKGZ1bmN0aW9uICh2aWV3KSB7IHJldHVybiBcIlxcbiAgXCIgKyB2aWV3Lml0ZW0ucmVtb3RlOyB9KSxcblx0ICAgICAgICAgICAgICAgIGJ1dHRvbnM6IHtcblx0ICAgIFx0XHRcdFx0XCJNb3ZlIHRvIFRyYXNoXCI6IGZ1bmN0aW9uICgpIHtcblx0ICAgIFx0XHRcdFx0XHRyZW1vdGVzLmZvckVhY2goZnVuY3Rpb24gKHZpZXcpIHtcblx0XHRcdFx0XHRcdFx0XHRpZiAoIXZpZXcpIHJldHVybjtcblxuXHRcdFx0XHRcdFx0XHRcdHZhciBkaXIgPSBQYXRoLmRpcm5hbWUodmlldy5pdGVtLnJlbW90ZSkucmVwbGFjZSgvXFxcXC9nLCAnLycpLFxuXHRcdFx0XHRcdFx0XHRcdFx0cGFyZW50ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKGRpcik7XG5cblx0XHRcdFx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLmRlbGV0ZSh2aWV3Lml0ZW0ucmVtb3RlLCBmdW5jdGlvbiAoZXJyLCBsaXN0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoIWVyciAmJiBwYXJlbnQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0cGFyZW50Lm9wZW4oKTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0ICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXHQgICAgXHRcdFx0XHR9LFxuXHQgICAgXHRcdFx0XHRcIkNhbmNlbFwiOiBudWxsXG5cdCAgICBcdFx0XHR9XG5cdCAgICBcdFx0fSk7XG5cdCAgICAgICAgfSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6ZG93bmxvYWQtc2VsZWN0ZWQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0ICAgICAgICAgICAgdmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cdFx0XHRcdGlmICghcmVtb3RlcyB8fCByZW1vdGVzLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHRcdFx0YXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiKipSZW1vdGUtRlRQKio8YnIgLz5Zb3UgbmVlZCB0byBzZWxlY3QgYSBmb2xkZXIgZmlyc3RcIik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0ICAgICAgICAgICAgcmVtb3Rlcy5mb3JFYWNoKGZ1bmN0aW9uICh2aWV3KSB7XG5cdCAgICAgICAgICAgICAgICBpZiAoIXZpZXcpIHJldHVybjtcblxuXHQgICAgICAgICAgICAgICAgYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5kb3dubG9hZCh2aWV3Lml0ZW0ucmVtb3RlLCB0cnVlLCBmdW5jdGlvbiAoZXJyKSB7XG5cblx0ICAgICAgICAgICAgICAgIH0pXG5cdCAgICAgICAgICAgIH0pXG5cdCAgICAgICAgfSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6dXBsb2FkLXNlbGVjdGVkJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdHZhciBsb2NhbHMgPSAkKCcudHJlZS12aWV3IC5zZWxlY3RlZCcpLm1hcChmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdCAgICByZXR1cm4gdGhpcy5nZXRQYXRoID8gdGhpcy5nZXRQYXRoKCkgOiAnJztcblx0XHRcdFx0fSkuZ2V0KCk7XG5cblx0ICAgICAgICAgICAgbG9jYWxzLmZvckVhY2goZnVuY3Rpb24gKGxvY2FsKSB7XG5cdCAgICAgICAgICAgICAgICBpZiAoIWxvY2FsKSByZXR1cm47XG5cblx0ICAgICAgICAgICAgICAgIGF0b20ucHJvamVjdC5yZW1vdGVmdHAudXBsb2FkKGxvY2FsLCBmdW5jdGlvbiAoZXJyLCBsaXN0KSB7XG5cdFx0XHRcdFx0XHRpZiAoZXJyKVxuXHRcdFx0XHRcdFx0XHRyZXR1cm47XG5cblx0XHRcdFx0XHRcdHZhciBkaXJzID0gW107XG5cdFx0XHRcdFx0XHRsaXN0LmZvckVhY2goZnVuY3Rpb24gKGl0ZW0pIHtcblx0XHRcdFx0XHRcdFx0dmFyIHJlbW90ZSA9IGF0b20ucHJvamVjdC5yZW1vdGVmdHAudG9SZW1vdGUoaXRlbS5uYW1lKSxcblx0XHRcdFx0XHRcdFx0XHRkaXIgPSBQYXRoLmRpcm5hbWUocmVtb3RlKTtcblx0XHRcdFx0XHRcdFx0aWYgKGRpcnMuaW5kZXhPZihkaXIpID09IC0xKVxuXHRcdFx0XHRcdFx0XHRcdGRpcnMucHVzaChkaXIpO1xuXHRcdFx0XHRcdFx0fSk7XG5cblx0XHRcdFx0XHRcdGRpcnMuZm9yRWFjaChmdW5jdGlvbiAoZGlyKSB7XG5cdFx0XHRcdFx0XHRcdHZhciB2aWV3ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKGRpcik7XG5cblx0XHRcdFx0XHRcdFx0aWYgKHZpZXcpXG5cdFx0XHRcdFx0XHRcdFx0dmlldy5vcGVuKCk7XG5cdFx0XHRcdFx0XHR9KTtcblx0ICAgICAgICAgICAgICAgIH0pO1xuXHQgICAgICAgICAgICB9KTtcblx0ICAgICAgICB9LFxuXG5cdFx0XHQvLyBSZW1vdGUgLT4gbG9jYWxcblx0XHRcdCdyZW1vdGUtZnRwOnN5bmMtd2l0aC1yZW1vdGUnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHZhciByZW1vdGVzID0gc2VsZi50cmVlVmlldy5nZXRTZWxlY3RlZCgpO1xuXG5cdCAgICAgICAgICAgIHJlbW90ZXMuZm9yRWFjaChmdW5jdGlvbiAodmlldykge1xuXHQgICAgICAgICAgICAgICAgaWYgKCF2aWV3KSByZXR1cm47XG5cblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLnN5bmNSZW1vdGVMb2NhbCh2aWV3Lml0ZW0ucmVtb3RlLCBmdW5jdGlvbiAoZXJyKSB7XG5cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9LFxuXG5cdFx0XHQvLyBMb2NhbCAtPiBSZW1vdGVcblx0XHRcdCdyZW1vdGUtZnRwOnN5bmMtd2l0aC1sb2NhbCc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHRcdFx0XHR2YXIgbG9jYWxzID0gJCgnLnRyZWUtdmlldyAuc2VsZWN0ZWQnKS5tYXAoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHQgICAgcmV0dXJuIHRoaXMuZ2V0UGF0aCA/IHRoaXMuZ2V0UGF0aCgpIDogJyc7XG5cdFx0XHRcdH0pLmdldCgpO1xuXG5cdFx0XHRcdGxvY2Fscy5mb3JFYWNoKGZ1bmN0aW9uIChsb2NhbCkge1xuXHQgICAgICAgICAgICAgICAgaWYgKCFsb2NhbCkgcmV0dXJuO1xuXG5cdFx0XHRcdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5zeW5jTG9jYWxSZW1vdGUobG9jYWwsIGZ1bmN0aW9uIChlcnIpIHtcblx0XHRcdFx0XHRcdHZhciByZW1vdGUgPSBhdG9tLnByb2plY3QucmVtb3RlZnRwLnRvUmVtb3RlKGxvY2FsKTtcblx0XHRcdFx0XHRcdGlmIChyZW1vdGUpIHtcblx0XHRcdFx0XHRcdFx0dmFyIHBhcmVudCA9IHNlbGYudHJlZVZpZXcucmVzb2x2ZShyZW1vdGUpO1xuXHRcdFx0XHRcdFx0XHRpZiAoIShwYXJlbnQuaXRlbSBpbnN0YW5jZW9mIERpcmVjdG9yeSkpXG5cdFx0XHRcdFx0XHRcdFx0cGFyZW50ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKFBhdGguZGlybmFtZShyZW1vdGUpLnJlcGxhY2UoL1xcXFwvZywgJy8nKSk7XG5cblx0XHRcdFx0XHRcdFx0aWYgKHBhcmVudClcblx0XHRcdFx0XHRcdFx0XHRwYXJlbnQub3BlbigpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cblx0XHRcdCdyZW1vdGUtZnRwOmFib3J0LWN1cnJlbnQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5hYm9ydCgpO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6bmF2aWdhdGUtdG8nOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0aWYgKCFBZGREaWFsb2cpXG5cdCAgICAgICAgICAgICAgICBBZGREaWFsb2cgPSByZXF1aXJlKCcuL2RpYWxvZ3MvbmF2aWdhdGUtdG8tZGlhbG9nJyk7XG5cblx0ICAgICAgICAgICAgdmFyIGRpYWxvZyA9IG5ldyBOYXZpZ2F0ZVRvKCk7XG5cdCAgICBcdFx0ZGlhbG9nLm9uKCduYXZpZ2F0ZS10bycsIGZ1bmN0aW9uIChlLCBwYXRoKSB7XG5cdFx0XHRcdFx0ZGlhbG9nLmNsb3NlKCk7XG5cblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLnJvb3Qub3BlblBhdGgocGF0aCk7XG5cdCAgICBcdFx0fSk7XG5cdCAgICAgICAgICAgIGRpYWxvZy5hdHRhY2goKTtcblx0XHRcdH1cblx0XHR9KVxuXG5cdFx0YXRvbS53b3Jrc3BhY2UuZWFjaEVkaXRvcihmdW5jdGlvbiAoZWQpIHtcblx0XHRcdHZhciBidWZmZXIgPSBlZC5idWZmZXI7XG5cdFx0XHRidWZmZXIub24oJ3NhdmVkJywgc2VsZi5maWxlU2F2ZWQuYmluZChzZWxmKSk7XG5cdFx0fSk7XG5cdH0sXG5cblx0ZGVhY3RpdmF0ZTogZnVuY3Rpb24gKCkge1xuXHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRhdG9tLndvcmtzcGFjZS5lYWNoRWRpdG9yKGZ1bmN0aW9uIChlZCkge1xuXHRcdFx0dmFyIGJ1ZmZlciA9IGVkLmJ1ZmZlcjtcblx0XHRcdGJ1ZmZlci5vZmYoJ3NhdmVkJywgc2VsZi5maWxlU2F2ZWQpO1xuXHRcdH0pO1xuXG5cdFx0aWYgKGF0b20ucHJvamVjdC5yZW1vdGVmdHApXG5cdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLmRpc2Nvbm5lY3QoKTtcblx0fSxcblxuXHRmaWxlU2F2ZWQ6IGZ1bmN0aW9uICh0ZXh0KSB7XG5cdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHRcdHZhciBzZWxmID0gdGhpcztcblxuXHRcdC8vaWYgKCFhdG9tLnByb2plY3QucmVtb3RlZnRwLmlzQ29ubmVjdGVkKCkpXG5cdFx0Ly9cdHJldHVybjtcblxuXHRcdHZhciBsb2NhbCA9IHRleHQuZmlsZS5wYXRoO1xuXG5cdFx0aWYgKCFhdG9tLnByb2plY3QuY29udGFpbnMobG9jYWwpKVxuXHRcdFx0cmV0dXJuO1xuXG5cdFx0aWYgKGxvY2FsID09IGF0b20ucHJvamVjdC5yZXNvbHZlKCcuZnRwY29uZmlnJykpXG5cdFx0XHRyZXR1cm47XG5cblx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLnVwbG9hZChsb2NhbCwgZnVuY3Rpb24gKGVycikge1xuXHRcdFx0dHJ5IHtcblx0XHRcdFx0dmFyIHJlbW90ZSA9IGF0b20ucHJvamVjdC5yZW1vdGVmdHAudG9SZW1vdGUobG9jYWwpLFxuXHRcdFx0XHRcdHBhcmVudCA9IGF0b20ucHJvamVjdC5yZW1vdGVmdHAucmVzb2x2ZShQYXRoLmRpcm5hbWUocmVtb3RlKS5yZXBsYWNlKC9cXFxcL2csICcvJykpO1xuXHRcdFx0XHRpZiAocGFyZW50KVxuXHRcdFx0XHRcdHBhcmVudC5vcGVuKCk7XG5cdFx0XHR9IGNhdGNoIChlKSB7fVxuXHRcdH0pO1xuXHR9XG59XG4iXX0=