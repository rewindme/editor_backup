var FS, Path, $, Client, TreeView, AddDialog, MoveDialog;

function hasProject() {
	return atom.project && atom.project.getPaths().length;
}

module.exports = {
	config: {
		hideLocalWhenDisplayed: {
			type: 'boolean',
			'default': false
		},
		autoUploadOnSave: {
			type: 'boolean',
			'default': true
		}
	},

	treeView: null,
	client: null,

	activate: function activate(state) {
		var self = this;

		if (!FS) {
			FS = require('fs-plus');
			Path = require('path');
			$ = require('atom-space-pen-views').$;

			Client = require('./client');
			TreeView = require('./views/tree-view');
			Directory = require('./directory');
		}

		atom.project.remoteftp = new Client();

		self.treeView = new TreeView();
		self.treeView.detach();

		atom.project.remoteftp.on('connected', function () {
			self.treeView.root.name.attr('data-name', Path.basename(atom.project.remoteftp.root.remote));
			self.treeView.root.name.attr('data-path', atom.project.remoteftp.root.remote);
		});

		if (hasProject() && atom.project.getDirectories()[0].resolve('.ftpconfig')) {
			FS.exists(atom.project.getDirectories()[0].resolve('.ftpconfig'), function (exists) {
				if (exists) self.treeView.attach();
			});
		}

		atom.commands.add('atom-workspace', {

			'remote-ftp:create-ftp-config': function remoteFtpCreateFtpConfig() {
				if (!hasProject()) return;

				FS.writeFile(atom.project.getDirectories()[0].resolve('.ftpconfig'), '{\n    "protocol": "ftp",\n    "host": "example.com",\n    "port": 21,\n    "user": "user",\n    "pass": "pass",\n    "remote": "/",\n    "secure": false,\n    "secureOptions": null,\n    "connTimeout": 10000,\n    "pasvTimeout": 10000,\n    "keepalive": 10000\n}', function (err) {
					if (!err) atom.workspace.open(atom.project.getDirectories()[0].resolve('.ftpconfig'));
				});
			},

			'remote-ftp:create-sftp-config': function remoteFtpCreateSftpConfig() {
				if (!hasProject()) return;

				FS.writeFile(atom.project.getDirectories()[0].resolve('.ftpconfig'), '{\n    "protocol": "sftp",\n    "host": "example.com",\n    "port": 22,\n    "user": "user",\n    "pass": "pass",\n    "remote": "/",\n    "agent": "",\n    "privatekey": "",\n    "passphrase": "",\n    "hosthash": "",\n    "ignorehost": true,\n    "connTimeout": 10000,\n    "keepalive": 10000,\n    "keyboardInteractive": false\n}', function (err) {
					if (!err) atom.workspace.open(atom.project.getDirectories()[0].resolve('.ftpconfig'));
				});
			},

			'remote-ftp:toggle': function remoteFtpToggle() {
				if (!hasProject()) return;

				self.treeView.toggle();
			},

			'remote-ftp:connect': function remoteFtpConnect() {
				if (!hasProject()) return;

				atom.project.remoteftp.readConfig(function (e) {
					if (e) {
						throw 'Could not read `.ftpconfig` file';
						return;
					}

					if (!self.treeView.isVisible()) {
						self.treeView.toggle();
					}

					atom.project.remoteftp.connect();
				});
			},

			'remote-ftp:disconnect': function remoteFtpDisconnect() {
				if (!hasProject()) return;

				atom.project.remoteftp.disconnect();
			},

			'remote-ftp:add-file': function remoteFtpAddFile() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				if (!AddDialog) AddDialog = require('./dialogs/add-dialog');

				var dialog = new AddDialog('', true);
				dialog.on('new-path', function (e, name) {
					dialog.close();

					var remote = Path.join(remotes[0].item.remote, name).replace(/\\/g, '/');

					atom.project.remoteftp.mkdir(remotes[0].item.remote, true, function (err) {
						atom.project.remoteftp.mkfile(remote, function (err) {

							remotes[0].open();

							if (!err) atom.workspace.open(atom.project.remoteftp.toLocal(remote));
						});
					});
				});
				dialog.attach();
			},

			'remote-ftp:add-folder': function remoteFtpAddFolder() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				if (!AddDialog) AddDialog = require('./dialogs/add-dialog');

				var dialog = new AddDialog('');
				dialog.on('new-path', function (e, name) {
					var remote = Path.join(remotes[0].item.remote, name).replace(/\\/g, '/');

					atom.project.remoteftp.mkdir(remote, true, function (err) {
						dialog.close();

						remotes[0].open();
					});
				});
				dialog.attach();
			},

			'remote-ftp:refresh-selected': function remoteFtpRefreshSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				remotes.forEach(function (remote) {
					remote.open();
				});
			},

			'remote-ftp:move-selected': function remoteFtpMoveSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				if (!MoveDialog) MoveDialog = require('./dialogs/move-dialog');

				var dialog = new MoveDialog(remotes[0].item.remote);
				dialog.on('path-changed', function (e, newremote) {
					atom.project.remoteftp.rename(remotes[0].item.remote, newremote, function (error) {
						dialog.close();

						// Refresh new folder
						var parentNew = self.treeView.resolve(Path.dirname(newremote));
						if (parentNew) parentNew.open();

						// Refresh old folder
						var parentOld = self.treeView.resolve(Path.dirname(remotes[0].item.remote));
						if (parentOld && parentOld != parentNew) parentOld.open();

						remotes[0].destroy();
					});
				});
				dialog.attach();
			},

			'remote-ftp:delete-selected': function remoteFtpDeleteSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				atom.confirm({
					message: 'Are you sure you want to delete the selected item?',
					detailedMessage: 'You are deleting:' + remotes.map(function (view) {
						return '\n  ' + view.item.remote;
					}),
					buttons: {
						'Move to Trash': function MoveToTrash() {
							remotes.forEach(function (view) {
								if (!view) return;

								var dir = Path.dirname(view.item.remote).replace(/\\/g, '/'),
								    parent = self.treeView.resolve(dir);

								atom.project.remoteftp['delete'](view.item.remote, function (err, list) {
									if (!err && parent) {
										parent.open();
									}
								});
							});
						},
						'Cancel': null
					}
				});
			},

			'remote-ftp:download-selected': function remoteFtpDownloadSelected() {
				if (!hasProject()) return;

				var remotes = self.treeView.getSelected();
				if (!remotes || remotes.length == 0) {
					atom.notifications.addError('**Remote-FTP**<br />You need to select a folder first');
					return;
				}

				remotes.forEach(function (view) {
					if (!view) return;

					atom.project.remoteftp.download(view.item.remote, true, function (err) {});
				});
			},

			'remote-ftp:upload-selected': function remoteFtpUploadSelected() {
				if (!hasProject()) return;

				var locals = $('.tree-view .selected').map(function () {
					return this.getPath ? this.getPath() : '';
				}).get();

				locals.forEach(function (local) {
					if (!local) return;

					atom.project.remoteftp.upload(local, function (err, list) {
						if (err) return;

						var dirs = [];
						list.forEach(function (item) {
							var remote = atom.project.remoteftp.toRemote(item.name),
							    dir = Path.dirname(remote);
							if (dirs.indexOf(dir) == -1) dirs.push(dir);
						});

						dirs.forEach(function (dir) {
							var view = self.treeView.resolve(dir);

							if (view) view.open();
						});
					});
				});
			},

			// Remote -> local
			'remote-ftp:sync-with-remote': function remoteFtpSyncWithRemote() {
				var remotes = self.treeView.getSelected();

				remotes.forEach(function (view) {
					if (!view) return;

					atom.project.remoteftp.syncRemoteLocal(view.item.remote, function (err) {});
				});
			},

			// Local -> Remote
			'remote-ftp:sync-with-local': function remoteFtpSyncWithLocal() {
				if (!hasProject()) return;

				var locals = $('.tree-view .selected').map(function () {
					return this.getPath ? this.getPath() : '';
				}).get();

				locals.forEach(function (local) {
					if (!local) return;

					atom.project.remoteftp.syncLocalRemote(local, function (err) {
						var remote = atom.project.remoteftp.toRemote(local);
						if (remote) {
							var parent = self.treeView.resolve(remote);
							if (parent && !(parent.item instanceof Directory)) parent = self.treeView.resolve(Path.dirname(remote).replace(/\\/g, '/'));

							if (parent) parent.open();
						}
					});
				});
			},

			'remote-ftp:abort-current': function remoteFtpAbortCurrent() {
				if (!hasProject()) return;

				atom.project.remoteftp.abort();
			},

			'remote-ftp:navigate-to': function remoteFtpNavigateTo() {
				if (!hasProject()) return;

				if (!AddDialog) AddDialog = require('./dialogs/navigate-to-dialog');

				var dialog = new NavigateTo();
				dialog.on('navigate-to', function (e, path) {
					dialog.close();

					atom.project.remoteftp.root.openPath(path);
				});
				dialog.attach();
			}
		});

		atom.workspace.observeTextEditors(function (ed) {
			var buffer = ed.buffer;
			buffer.onDidSave(self.fileSaved.bind(self));
		});
	},

	deactivate: function deactivate() {
		var self = this;
		atom.workspace.observeTextEditors(function (ed) {
			var buffer = ed.buffer;
			buffer.off('saved', self.fileSaved);
		});

		if (atom.project.remoteftp) atom.project.remoteftp.disconnect();
	},

	fileSaved: function fileSaved(text) {
		if (!hasProject()) return;

		if (!atom.config.get('Remote-FTP.autoUploadOnSave')) return;

		var self = this;

		//if (!atom.project.remoteftp.isConnected())
		//	return;

		var local = text.path;

		if (!atom.project.contains(local)) return;

		if (local == atom.project.getDirectories()[0].resolve('.ftpconfig')) return;

		atom.project.remoteftp.upload(local, function (err) {
			try {
				var remote = atom.project.remoteftp.toRemote(local),
				    parent = atom.project.remoteftp.resolve(Path.dirname(remote).replace(/\\/g, '/'));
				if (parent) parent.open();
			} catch (e) {}
		});
	}
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9uYXZlci8uYXRvbS9wYWNrYWdlcy9yZW1vdGUtZnRwL2xpYi9yZW1vdGUtZnRwLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLElBQUksRUFBRSxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDOztBQUV6RCxTQUFTLFVBQVUsR0FBSTtBQUN0QixRQUFPLElBQUksQ0FBQyxPQUFPLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsQ0FBQyxNQUFNLENBQUM7Q0FDdEQ7O0FBRUQsTUFBTSxDQUFDLE9BQU8sR0FBRztBQUNoQixPQUFNLEVBQUU7QUFDUCx3QkFBc0IsRUFBRTtBQUN2QixPQUFJLEVBQUUsU0FBUztBQUNmLFlBQVMsRUFBRSxLQUFLO0dBQ2hCO0FBQ0Qsa0JBQWdCLEVBQUU7QUFDakIsT0FBSSxFQUFFLFNBQVM7QUFDZixZQUFTLEVBQUUsSUFBSTtHQUNmO0VBQ0Q7O0FBRUQsU0FBUSxFQUFFLElBQUk7QUFDZCxPQUFNLEVBQUUsSUFBSTs7QUFFWixTQUFRLEVBQUUsa0JBQVUsS0FBSyxFQUFFO0FBQzFCLE1BQUksSUFBSSxHQUFHLElBQUksQ0FBQzs7QUFFaEIsTUFBSSxDQUFDLEVBQUUsRUFBRTtBQUNSLEtBQUUsR0FBRyxPQUFPLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDeEIsT0FBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN2QixJQUFDLEdBQUcsT0FBTyxDQUFDLHNCQUFzQixDQUFDLENBQUMsQ0FBQyxDQUFDOztBQUV0QyxTQUFNLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQzdCLFdBQVEsR0FBRyxPQUFPLENBQUMsbUJBQW1CLENBQUMsQ0FBQztBQUN4QyxZQUFTLEdBQUcsT0FBTyxDQUFDLGFBQWEsQ0FBQyxDQUFDO0dBQ25DOztBQUVELE1BQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxHQUFHLElB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SUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQ2hDLE9BQU87O0FBRVIsTUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxjQUFjLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxPQUFPLENBQUMsWUFBWSxDQUFDLEVBQ2xFLE9BQU87O0FBRVIsTUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxVQUFVLEdBQUcsRUFBRTtBQUNuRCxPQUFJO0FBQ0gsUUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztRQUNsRCxNQUFNLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO0FBQ25GLFFBQUksTUFBTSxFQUNULE1BQU0sQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUNmLENBQUMsT0FBTyxDQUFDLEVBQUUsRUFBRTtHQUNkLENBQUMsQ0FBQztFQUNIO0NBQ0QsQ0FBQSIsImZpbGUiOiIvVXNlcnMvbmF2ZXIvLmF0b20vcGFja2FnZXMvcmVtb3RlLWZ0cC9saWIvcmVtb3RlLWZ0cC5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBGUywgUGF0aCwgJCwgQ2xpZW50LCBUcmVlVmlldywgQWRkRGlhbG9nLCBNb3ZlRGlhbG9nO1xuXG5mdW5jdGlvbiBoYXNQcm9qZWN0ICgpIHtcblx0cmV0dXJuIGF0b20ucHJvamVjdCAmJiBhdG9tLnByb2plY3QuZ2V0UGF0aHMoKS5sZW5ndGg7XG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuXHRjb25maWc6IHtcblx0XHRoaWRlTG9jYWxXaGVuRGlzcGxheWVkOiB7XG5cdFx0XHR0eXBlOiAnYm9vbGVhbicsXG5cdFx0XHQnZGVmYXVsdCc6IGZhbHNlXG5cdFx0fSxcblx0XHRhdXRvVXBsb2FkT25TYXZlOiB7XG5cdFx0XHR0eXBlOiAnYm9vbGVhbicsXG5cdFx0XHQnZGVmYXVsdCc6IHRydWVcblx0XHR9XG5cdH0sXG5cblx0dHJlZVZpZXc6IG51bGwsXG5cdGNsaWVudDogbnVsbCxcblxuXHRhY3RpdmF0ZTogZnVuY3Rpb24gKHN0YXRlKSB7XG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cdFx0aWYgKCFGUykge1xuXHRcdFx0RlMgPSByZXF1aXJlKCdmcy1wbHVzJyk7XG5cdFx0XHRQYXRoID0gcmVxdWlyZSgncGF0aCcpO1xuXHRcdFx0JCA9IHJlcXVpcmUoJ2F0b20tc3BhY2UtcGVuLXZpZXdzJykuJDtcblxuXHRcdFx0Q2xpZW50ID0gcmVxdWlyZSgnLi9jbGllbnQnKTtcblx0XHRcdFRyZWVWaWV3ID0gcmVxdWlyZSgnLi92aWV3cy90cmVlLXZpZXcnKTtcblx0XHRcdERpcmVjdG9yeSA9IHJlcXVpcmUoJy4vZGlyZWN0b3J5Jyk7XG5cdFx0fVxuXG5cdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cCA9IG5ldyBDbGllbnQoKTtcblxuXHRcdHNlbGYudHJlZVZpZXcgPSBuZXcgVHJlZVZpZXcoKTtcblx0XHRzZWxmLnRyZWVWaWV3LmRldGFjaCgpO1xuXG5cdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5vbignY29ubmVjdGVkJywgZnVuY3Rpb24gKCkge1xuXHRcdFx0c2VsZi50cmVlVmlldy5yb290Lm5hbWUuYXR0cignZGF0YS1uYW1lJywgUGF0aC5iYXNlbmFtZShhdG9tLnByb2plY3QucmVtb3RlZnRwLnJvb3QucmVtb3RlKSk7XG5cdFx0XHRzZWxmLnRyZWVWaWV3LnJvb3QubmFtZS5hdHRyKCdkYXRhLXBhdGgnLCBhdG9tLnByb2plY3QucmVtb3RlZnRwLnJvb3QucmVtb3RlKTtcblx0XHR9KTtcblxuXHRcdGlmIChoYXNQcm9qZWN0KCkgJiYgYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKClbMF0ucmVzb2x2ZSgnLmZ0cGNvbmZpZycpKSB7XG5cdFx0XHRGUy5leGlzdHMoYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKClbMF0ucmVzb2x2ZSgnLmZ0cGNvbmZpZycpLCBmdW5jdGlvbiAoZXhpc3RzKSB7XG5cdFx0XHRcdGlmIChleGlzdHMpXG5cdFx0XHRcdFx0c2VsZi50cmVlVmlldy5hdHRhY2goKTtcblx0XHRcdH0pO1xuXHRcdH1cblxuXHRcdGF0b20uY29tbWFuZHMuYWRkKCdhdG9tLXdvcmtzcGFjZScsIHtcblxuXHRcdFx0J3JlbW90ZS1mdHA6Y3JlYXRlLWZ0cC1jb25maWcnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0RlMud3JpdGVGaWxlKGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpWzBdLnJlc29sdmUoJy5mdHBjb25maWcnKSwgJ3tcXG5cXFxuICAgIFwicHJvdG9jb2xcIjogXCJmdHBcIixcXG5cXFxuICAgIFwiaG9zdFwiOiBcImV4YW1wbGUuY29tXCIsXFxuXFxcbiAgICBcInBvcnRcIjogMjEsXFxuXFxcbiAgICBcInVzZXJcIjogXCJ1c2VyXCIsXFxuXFxcbiAgICBcInBhc3NcIjogXCJwYXNzXCIsXFxuXFxcbiAgICBcInJlbW90ZVwiOiBcIi9cIixcXG5cXFxuICAgIFwic2VjdXJlXCI6IGZhbHNlLFxcblxcXG4gICAgXCJzZWN1cmVPcHRpb25zXCI6IG51bGwsXFxuXFxcbiAgICBcImNvbm5UaW1lb3V0XCI6IDEwMDAwLFxcblxcXG4gICAgXCJwYXN2VGltZW91dFwiOiAxMDAwMCxcXG5cXFxuICAgIFwia2VlcGFsaXZlXCI6IDEwMDAwXFxuXFxcbn0nXHRcdFx0LCBmdW5jdGlvbiAoZXJyKSB7XG5cdFx0XHRcdFx0aWYgKCFlcnIpXG5cdFx0XHRcdFx0XHRhdG9tLndvcmtzcGFjZS5vcGVuKGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpWzBdLnJlc29sdmUoJy5mdHBjb25maWcnKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6Y3JlYXRlLXNmdHAtY29uZmlnJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdEZTLndyaXRlRmlsZShhdG9tLnByb2plY3QuZ2V0RGlyZWN0b3JpZXMoKVswXS5yZXNvbHZlKCcuZnRwY29uZmlnJyksICd7XFxuXFxcbiAgICBcInByb3RvY29sXCI6IFwic2Z0cFwiLFxcblxcXG4gICAgXCJob3N0XCI6IFwiZXhhbXBsZS5jb21cIixcXG5cXFxuICAgIFwicG9ydFwiOiAyMixcXG5cXFxuICAgIFwidXNlclwiOiBcInVzZXJcIixcXG5cXFxuICAgIFwicGFzc1wiOiBcInBhc3NcIixcXG5cXFxuICAgIFwicmVtb3RlXCI6IFwiL1wiLFxcblxcXG4gICAgXCJhZ2VudFwiOiBcIlwiLFxcblxcXG4gICAgXCJwcml2YXRla2V5XCI6IFwiXCIsXFxuXFxcbiAgICBcInBhc3NwaHJhc2VcIjogXCJcIixcXG5cXFxuICAgIFwiaG9zdGhhc2hcIjogXCJcIixcXG5cXFxuICAgIFwiaWdub3JlaG9zdFwiOiB0cnVlLFxcblxcXG4gICAgXCJjb25uVGltZW91dFwiOiAxMDAwMCxcXG5cXFxuICAgIFwia2VlcGFsaXZlXCI6IDEwMDAwLFxcblxcXG4gICAgXCJrZXlib2FyZEludGVyYWN0aXZlXCI6IGZhbHNlXFxuXFxcbn0nXHRcdFx0LCBmdW5jdGlvbiAoZXJyKSB7XG5cdFx0XHRcdFx0aWYgKCFlcnIpXG5cdFx0XHRcdFx0XHRhdG9tLndvcmtzcGFjZS5vcGVuKGF0b20ucHJvamVjdC5nZXREaXJlY3RvcmllcygpWzBdLnJlc29sdmUoJy5mdHBjb25maWcnKSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6dG9nZ2xlJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdHNlbGYudHJlZVZpZXcudG9nZ2xlKCk7XG5cdFx0XHR9LFxuXG5cdFx0XHQncmVtb3RlLWZ0cDpjb25uZWN0JzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAucmVhZENvbmZpZyhmdW5jdGlvbiAoZSkge1xuXHRcdFx0XHRcdGlmIChlKSB7XG5cdFx0XHRcdFx0XHR0aHJvdyBcIkNvdWxkIG5vdCByZWFkIGAuZnRwY29uZmlnYCBmaWxlXCI7XG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdFx0fVxuXG5cdFx0XHRcdFx0aWYgKCFzZWxmLnRyZWVWaWV3LmlzVmlzaWJsZSgpKSB7XG5cdFx0XHRcdFx0XHRzZWxmLnRyZWVWaWV3LnRvZ2dsZSgpO1xuXHRcdFx0XHRcdH1cblxuXHRcdFx0XHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAuY29ubmVjdCgpO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cblx0XHRcdCdyZW1vdGUtZnRwOmRpc2Nvbm5lY3QnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5kaXNjb25uZWN0KCk7XG5cdFx0XHR9LFxuXG5cdFx0XHQncmVtb3RlLWZ0cDphZGQtZmlsZSc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHRcdFx0XHR2YXIgcmVtb3RlcyA9IHNlbGYudHJlZVZpZXcuZ2V0U2VsZWN0ZWQoKTtcblx0XHRcdFx0aWYgKCFyZW1vdGVzIHx8IHJlbW90ZXMubGVuZ3RoID09IDApIHtcblx0XHRcdFx0XHRhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCIqKlJlbW90ZS1GVFAqKjxiciAvPllvdSBuZWVkIHRvIHNlbGVjdCBhIGZvbGRlciBmaXJzdFwiKTtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoIUFkZERpYWxvZylcblx0XHRcdFx0XHRBZGREaWFsb2cgPSByZXF1aXJlKCcuL2RpYWxvZ3MvYWRkLWRpYWxvZycpO1xuXG5cdFx0XHRcdHZhciBkaWFsb2cgPSBuZXcgQWRkRGlhbG9nKCcnLCB0cnVlKTtcblx0XHRcdFx0ZGlhbG9nLm9uKCduZXctcGF0aCcsIGZ1bmN0aW9uIChlLCBuYW1lKSB7XG5cdFx0XHRcdFx0ZGlhbG9nLmNsb3NlKCk7XG5cblx0XHRcdFx0XHR2YXIgcmVtb3RlID0gUGF0aC5qb2luKHJlbW90ZXNbMF0uaXRlbS5yZW1vdGUsIG5hbWUpLnJlcGxhY2UoL1xcXFwvZywgJy8nKTtcblxuXHRcdFx0XHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAubWtkaXIocmVtb3Rlc1swXS5pdGVtLnJlbW90ZSwgdHJ1ZSwgZnVuY3Rpb24gKGVycikge1xuXHRcdFx0XHRcdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5ta2ZpbGUocmVtb3RlLCBmdW5jdGlvbiAoZXJyKSB7XG5cblx0XHRcdFx0XHRcdFx0cmVtb3Rlc1swXS5vcGVuKCk7XG5cblx0XHRcdFx0XHRcdFx0aWYgKCFlcnIpXG5cdFx0XHRcdFx0XHRcdFx0YXRvbS53b3Jrc3BhY2Uub3BlbihhdG9tLnByb2plY3QucmVtb3RlZnRwLnRvTG9jYWwocmVtb3RlKSk7XG5cdFx0XHRcdFx0XHR9KVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdFx0ZGlhbG9nLmF0dGFjaCgpO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6YWRkLWZvbGRlcic6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHRcdFx0XHR2YXIgcmVtb3RlcyA9IHNlbGYudHJlZVZpZXcuZ2V0U2VsZWN0ZWQoKTtcblx0XHRcdFx0aWYgKCFyZW1vdGVzIHx8IHJlbW90ZXMubGVuZ3RoID09IDApIHtcblx0XHRcdFx0XHRhdG9tLm5vdGlmaWNhdGlvbnMuYWRkRXJyb3IoXCIqKlJlbW90ZS1GVFAqKjxiciAvPllvdSBuZWVkIHRvIHNlbGVjdCBhIGZvbGRlciBmaXJzdFwiKTtcblx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRpZiAoIUFkZERpYWxvZylcblx0XHRcdFx0XHRBZGREaWFsb2cgPSByZXF1aXJlKCcuL2RpYWxvZ3MvYWRkLWRpYWxvZycpO1xuXG5cdFx0XHRcdHZhciBkaWFsb2cgPSBuZXcgQWRkRGlhbG9nKCcnKTtcblx0XHRcdFx0ZGlhbG9nLm9uKCduZXctcGF0aCcsIGZ1bmN0aW9uIChlLCBuYW1lKSB7XG5cdFx0XHRcdFx0dmFyIHJlbW90ZSA9IFBhdGguam9pbihyZW1vdGVzWzBdLml0ZW0ucmVtb3RlLCBuYW1lKS5yZXBsYWNlKC9cXFxcL2csICcvJyk7XG5cblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLm1rZGlyKHJlbW90ZSwgdHJ1ZSwgZnVuY3Rpb24gKGVycikge1xuXHRcdFx0XHRcdFx0ZGlhbG9nLmNsb3NlKCk7XG5cblx0XHRcdFx0XHRcdHJlbW90ZXNbMF0ub3BlbigpO1xuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRkaWFsb2cuYXR0YWNoKCk7XG5cdFx0XHR9LFxuXG5cdFx0XHQncmVtb3RlLWZ0cDpyZWZyZXNoLXNlbGVjdGVkJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdHZhciByZW1vdGVzID0gc2VsZi50cmVlVmlldy5nZXRTZWxlY3RlZCgpO1xuXHRcdFx0XHRpZiAoIXJlbW90ZXMgfHwgcmVtb3Rlcy5sZW5ndGggPT0gMCkge1xuXHRcdFx0XHRcdGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcIioqUmVtb3RlLUZUUCoqPGJyIC8+WW91IG5lZWQgdG8gc2VsZWN0IGEgZm9sZGVyIGZpcnN0XCIpO1xuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdHJlbW90ZXMuZm9yRWFjaChmdW5jdGlvbiAocmVtb3RlKSB7XG5cdFx0XHRcdFx0cmVtb3RlLm9wZW4oKTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9LFxuXG5cdFx0XHQncmVtb3RlLWZ0cDptb3ZlLXNlbGVjdGVkJzogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0XHRcdHZhciByZW1vdGVzID0gc2VsZi50cmVlVmlldy5nZXRTZWxlY3RlZCgpO1xuXHRcdFx0XHRpZiAoIXJlbW90ZXMgfHwgcmVtb3Rlcy5sZW5ndGggPT0gMCkge1xuXHRcdFx0XHRcdGF0b20ubm90aWZpY2F0aW9ucy5hZGRFcnJvcihcIioqUmVtb3RlLUZUUCoqPGJyIC8+WW91IG5lZWQgdG8gc2VsZWN0IGEgZm9sZGVyIGZpcnN0XCIpO1xuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGlmICghTW92ZURpYWxvZylcblx0XHRcdFx0XHRNb3ZlRGlhbG9nID0gcmVxdWlyZSgnLi9kaWFsb2dzL21vdmUtZGlhbG9nJyk7XG5cblx0XHRcdFx0dmFyIGRpYWxvZyA9IG5ldyBNb3ZlRGlhbG9nKHJlbW90ZXNbMF0uaXRlbS5yZW1vdGUpO1xuXHRcdFx0XHRkaWFsb2cub24oJ3BhdGgtY2hhbmdlZCcsIGZ1bmN0aW9uIChlLCBuZXdyZW1vdGUpIHtcblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLnJlbmFtZShyZW1vdGVzWzBdLml0ZW0ucmVtb3RlLCBuZXdyZW1vdGUsIGZ1bmN0aW9uIChlcnJvcikge1xuXHRcdFx0XHRcdFx0ZGlhbG9nLmNsb3NlKCk7XG5cblx0XHRcdFx0XHRcdC8vIFJlZnJlc2ggbmV3IGZvbGRlclxuXHRcdFx0XHRcdFx0dmFyIHBhcmVudE5ldyA9IHNlbGYudHJlZVZpZXcucmVzb2x2ZShQYXRoLmRpcm5hbWUobmV3cmVtb3RlKSk7XG5cdFx0XHRcdFx0XHRpZiAocGFyZW50TmV3KVxuXHRcdFx0XHRcdFx0XHRwYXJlbnROZXcub3BlbigpO1xuXG5cdFx0XHRcdFx0XHQvLyBSZWZyZXNoIG9sZCBmb2xkZXJcblx0XHRcdFx0XHRcdHZhciBwYXJlbnRPbGQgPSBzZWxmLnRyZWVWaWV3LnJlc29sdmUoUGF0aC5kaXJuYW1lKHJlbW90ZXNbMF0uaXRlbS5yZW1vdGUpKTtcblx0XHRcdFx0XHRcdGlmIChwYXJlbnRPbGQgJiYgcGFyZW50T2xkICE9IHBhcmVudE5ldylcblx0XHRcdFx0XHRcdFx0cGFyZW50T2xkLm9wZW4oKTtcblxuXHRcdFx0XHRcdFx0cmVtb3Rlc1swXS5kZXN0cm95KCk7XG5cdFx0XHRcdFx0fSk7XG5cdFx0XHRcdH0pO1xuXHRcdFx0XHRkaWFsb2cuYXR0YWNoKCk7XG5cdFx0XHR9LFxuXG5cdFx0XHQncmVtb3RlLWZ0cDpkZWxldGUtc2VsZWN0ZWQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0dmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cdFx0XHRcdGlmICghcmVtb3RlcyB8fCByZW1vdGVzLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHRcdFx0YXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiKipSZW1vdGUtRlRQKio8YnIgLz5Zb3UgbmVlZCB0byBzZWxlY3QgYSBmb2xkZXIgZmlyc3RcIik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0YXRvbS5jb25maXJtKHtcblx0XHRcdFx0XHRtZXNzYWdlOiBcIkFyZSB5b3Ugc3VyZSB5b3Ugd2FudCB0byBkZWxldGUgdGhlIHNlbGVjdGVkIGl0ZW0/XCIsXG5cdFx0XHRcdFx0ZGV0YWlsZWRNZXNzYWdlOiBcIllvdSBhcmUgZGVsZXRpbmc6XCIrIHJlbW90ZXMubWFwKGZ1bmN0aW9uICh2aWV3KSB7IHJldHVybiBcIlxcbiAgXCIgKyB2aWV3Lml0ZW0ucmVtb3RlOyB9KSxcblx0XHRcdFx0XHRidXR0b25zOiB7XG5cdFx0XHRcdFx0XHRcIk1vdmUgdG8gVHJhc2hcIjogZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdFx0XHRyZW1vdGVzLmZvckVhY2goZnVuY3Rpb24gKHZpZXcpIHtcblx0XHRcdFx0XHRcdFx0XHRpZiAoIXZpZXcpIHJldHVybjtcblxuXHRcdFx0XHRcdFx0XHRcdHZhciBkaXIgPSBQYXRoLmRpcm5hbWUodmlldy5pdGVtLnJlbW90ZSkucmVwbGFjZSgvXFxcXC9nLCAnLycpLFxuXHRcdFx0XHRcdFx0XHRcdFx0cGFyZW50ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKGRpcik7XG5cblx0XHRcdFx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLmRlbGV0ZSh2aWV3Lml0ZW0ucmVtb3RlLCBmdW5jdGlvbiAoZXJyLCBsaXN0KSB7XG5cdFx0XHRcdFx0XHRcdFx0XHRpZiAoIWVyciAmJiBwYXJlbnQpIHtcblx0XHRcdFx0XHRcdFx0XHRcdFx0cGFyZW50Lm9wZW4oKTtcblx0XHRcdFx0XHRcdFx0XHRcdH1cblx0XHRcdFx0XHRcdFx0XHR9KTtcblx0XHRcdFx0XHRcdFx0IH0pO1xuXHRcdFx0XHRcdFx0fSxcblx0XHRcdFx0XHRcdFwiQ2FuY2VsXCI6IG51bGxcblx0XHRcdFx0XHR9XG5cdFx0XHRcdH0pO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6ZG93bmxvYWQtc2VsZWN0ZWQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0dmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cdFx0XHRcdGlmICghcmVtb3RlcyB8fCByZW1vdGVzLmxlbmd0aCA9PSAwKSB7XG5cdFx0XHRcdFx0YXRvbS5ub3RpZmljYXRpb25zLmFkZEVycm9yKFwiKipSZW1vdGUtRlRQKio8YnIgLz5Zb3UgbmVlZCB0byBzZWxlY3QgYSBmb2xkZXIgZmlyc3RcIik7XG5cdFx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0cmVtb3Rlcy5mb3JFYWNoKGZ1bmN0aW9uICh2aWV3KSB7XG5cdFx0XHRcdFx0aWYgKCF2aWV3KSByZXR1cm47XG5cblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLmRvd25sb2FkKHZpZXcuaXRlbS5yZW1vdGUsIHRydWUsIGZ1bmN0aW9uIChlcnIpIHtcblxuXHRcdFx0XHRcdH0pXG5cdFx0XHRcdH0pXG5cdFx0XHR9LFxuXG5cdFx0XHQncmVtb3RlLWZ0cDp1cGxvYWQtc2VsZWN0ZWQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0dmFyIGxvY2FscyA9ICQoJy50cmVlLXZpZXcgLnNlbGVjdGVkJykubWFwKGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0XHRyZXR1cm4gdGhpcy5nZXRQYXRoID8gdGhpcy5nZXRQYXRoKCkgOiAnJztcblx0XHRcdFx0fSkuZ2V0KCk7XG5cblx0XHRcdFx0bG9jYWxzLmZvckVhY2goZnVuY3Rpb24gKGxvY2FsKSB7XG5cdFx0XHRcdFx0aWYgKCFsb2NhbCkgcmV0dXJuO1xuXG5cdFx0XHRcdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC51cGxvYWQobG9jYWwsIGZ1bmN0aW9uIChlcnIsIGxpc3QpIHtcblx0XHRcdFx0XHRcdGlmIChlcnIpXG5cdFx0XHRcdFx0XHRcdHJldHVybjtcblxuXHRcdFx0XHRcdFx0dmFyIGRpcnMgPSBbXTtcblx0XHRcdFx0XHRcdGxpc3QuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xuXHRcdFx0XHRcdFx0XHR2YXIgcmVtb3RlID0gYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC50b1JlbW90ZShpdGVtLm5hbWUpLFxuXHRcdFx0XHRcdFx0XHRcdGRpciA9IFBhdGguZGlybmFtZShyZW1vdGUpO1xuXHRcdFx0XHRcdFx0XHRpZiAoZGlycy5pbmRleE9mKGRpcikgPT0gLTEpXG5cdFx0XHRcdFx0XHRcdFx0ZGlycy5wdXNoKGRpcik7XG5cdFx0XHRcdFx0XHR9KTtcblxuXHRcdFx0XHRcdFx0ZGlycy5mb3JFYWNoKGZ1bmN0aW9uIChkaXIpIHtcblx0XHRcdFx0XHRcdFx0dmFyIHZpZXcgPSBzZWxmLnRyZWVWaWV3LnJlc29sdmUoZGlyKTtcblxuXHRcdFx0XHRcdFx0XHRpZiAodmlldylcblx0XHRcdFx0XHRcdFx0XHR2aWV3Lm9wZW4oKTtcblx0XHRcdFx0XHRcdH0pO1xuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cblx0XHRcdC8vIFJlbW90ZSAtPiBsb2NhbFxuXHRcdFx0J3JlbW90ZS1mdHA6c3luYy13aXRoLXJlbW90ZSc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0dmFyIHJlbW90ZXMgPSBzZWxmLnRyZWVWaWV3LmdldFNlbGVjdGVkKCk7XG5cblx0XHRcdFx0cmVtb3Rlcy5mb3JFYWNoKGZ1bmN0aW9uICh2aWV3KSB7XG5cdFx0XHRcdFx0aWYgKCF2aWV3KSByZXR1cm47XG5cblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLnN5bmNSZW1vdGVMb2NhbCh2aWV3Lml0ZW0ucmVtb3RlLCBmdW5jdGlvbiAoZXJyKSB7XG5cblx0XHRcdFx0XHR9KTtcblx0XHRcdFx0fSk7XG5cdFx0XHR9LFxuXG5cdFx0XHQvLyBMb2NhbCAtPiBSZW1vdGVcblx0XHRcdCdyZW1vdGUtZnRwOnN5bmMtd2l0aC1sb2NhbCc6IGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0aWYgKCFoYXNQcm9qZWN0KCkpIHJldHVybjtcblxuXHRcdFx0XHR2YXIgbG9jYWxzID0gJCgnLnRyZWUtdmlldyAuc2VsZWN0ZWQnKS5tYXAoZnVuY3Rpb24gKCkge1xuXHRcdFx0XHRcdHJldHVybiB0aGlzLmdldFBhdGggPyB0aGlzLmdldFBhdGgoKSA6ICcnO1xuXHRcdFx0XHR9KS5nZXQoKTtcblxuXHRcdFx0XHRsb2NhbHMuZm9yRWFjaChmdW5jdGlvbiAobG9jYWwpIHtcblx0XHRcdFx0XHRpZiAoIWxvY2FsKSByZXR1cm47XG5cblx0XHRcdFx0XHRhdG9tLnByb2plY3QucmVtb3RlZnRwLnN5bmNMb2NhbFJlbW90ZShsb2NhbCwgZnVuY3Rpb24gKGVycikge1xuXHRcdFx0XHRcdFx0dmFyIHJlbW90ZSA9IGF0b20ucHJvamVjdC5yZW1vdGVmdHAudG9SZW1vdGUobG9jYWwpO1xuXHRcdFx0XHRcdFx0aWYgKHJlbW90ZSkge1xuXHRcdFx0XHRcdFx0XHR2YXIgcGFyZW50ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKHJlbW90ZSk7XG5cdFx0XHRcdFx0XHRcdGlmIChwYXJlbnQgJiYgIShwYXJlbnQuaXRlbSBpbnN0YW5jZW9mIERpcmVjdG9yeSkpXG5cdFx0XHRcdFx0XHRcdFx0cGFyZW50ID0gc2VsZi50cmVlVmlldy5yZXNvbHZlKFBhdGguZGlybmFtZShyZW1vdGUpLnJlcGxhY2UoL1xcXFwvZywgJy8nKSk7XG5cblx0XHRcdFx0XHRcdFx0aWYgKHBhcmVudClcblx0XHRcdFx0XHRcdFx0XHRwYXJlbnQub3BlbigpO1xuXHRcdFx0XHRcdFx0fVxuXHRcdFx0XHRcdH0pO1xuXHRcdFx0XHR9KTtcblx0XHRcdH0sXG5cblx0XHRcdCdyZW1vdGUtZnRwOmFib3J0LWN1cnJlbnQnOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5hYm9ydCgpO1xuXHRcdFx0fSxcblxuXHRcdFx0J3JlbW90ZS1mdHA6bmF2aWdhdGUtdG8nOiBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdGlmICghaGFzUHJvamVjdCgpKSByZXR1cm47XG5cblx0XHRcdFx0aWYgKCFBZGREaWFsb2cpXG5cdFx0XHRcdFx0QWRkRGlhbG9nID0gcmVxdWlyZSgnLi9kaWFsb2dzL25hdmlnYXRlLXRvLWRpYWxvZycpO1xuXG5cdFx0XHRcdHZhciBkaWFsb2cgPSBuZXcgTmF2aWdhdGVUbygpO1xuXHRcdFx0XHRkaWFsb2cub24oJ25hdmlnYXRlLXRvJywgZnVuY3Rpb24gKGUsIHBhdGgpIHtcblx0XHRcdFx0XHRkaWFsb2cuY2xvc2UoKTtcblxuXHRcdFx0XHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAucm9vdC5vcGVuUGF0aChwYXRoKTtcblx0XHRcdFx0fSk7XG5cdFx0XHRcdGRpYWxvZy5hdHRhY2goKTtcblx0XHRcdH1cblx0XHR9KVxuXG5cdFx0YXRvbS53b3Jrc3BhY2Uub2JzZXJ2ZVRleHRFZGl0b3JzKGZ1bmN0aW9uIChlZCkge1xuXHRcdFx0dmFyIGJ1ZmZlciA9IGVkLmJ1ZmZlcjtcblx0XHRcdGJ1ZmZlci5vbkRpZFNhdmUoc2VsZi5maWxlU2F2ZWQuYmluZChzZWxmKSk7XG5cdFx0fSk7XG5cdH0sXG5cblx0ZGVhY3RpdmF0ZTogZnVuY3Rpb24gKCkge1xuXHRcdHZhciBzZWxmID0gdGhpcztcblx0XHRhdG9tLndvcmtzcGFjZS5vYnNlcnZlVGV4dEVkaXRvcnMoZnVuY3Rpb24gKGVkKSB7XG5cdFx0XHR2YXIgYnVmZmVyID0gZWQuYnVmZmVyO1xuXHRcdFx0YnVmZmVyLm9mZignc2F2ZWQnLCBzZWxmLmZpbGVTYXZlZCk7XG5cdFx0fSk7XG5cblx0XHRpZiAoYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cClcblx0XHRcdGF0b20ucHJvamVjdC5yZW1vdGVmdHAuZGlzY29ubmVjdCgpO1xuXHR9LFxuXG5cdGZpbGVTYXZlZDogZnVuY3Rpb24gKHRleHQpIHtcblx0XHRpZiAoIWhhc1Byb2plY3QoKSkgcmV0dXJuO1xuXG5cdFx0aWYgKCFhdG9tLmNvbmZpZy5nZXQoJ1JlbW90ZS1GVFAuYXV0b1VwbG9hZE9uU2F2ZScpKSByZXR1cm47XG5cblx0XHR2YXIgc2VsZiA9IHRoaXM7XG5cblx0XHQvL2lmICghYXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC5pc0Nvbm5lY3RlZCgpKVxuXHRcdC8vXHRyZXR1cm47XG5cblx0XHR2YXIgbG9jYWwgPSB0ZXh0LnBhdGg7XG5cblx0XHRpZiAoIWF0b20ucHJvamVjdC5jb250YWlucyhsb2NhbCkpXG5cdFx0XHRyZXR1cm47XG5cblx0XHRpZiAobG9jYWwgPT0gYXRvbS5wcm9qZWN0LmdldERpcmVjdG9yaWVzKClbMF0ucmVzb2x2ZSgnLmZ0cGNvbmZpZycpKVxuXHRcdFx0cmV0dXJuO1xuXG5cdFx0YXRvbS5wcm9qZWN0LnJlbW90ZWZ0cC51cGxvYWQobG9jYWwsIGZ1bmN0aW9uIChlcnIpIHtcblx0XHRcdHRyeSB7XG5cdFx0XHRcdHZhciByZW1vdGUgPSBhdG9tLnByb2plY3QucmVtb3RlZnRwLnRvUmVtb3RlKGxvY2FsKSxcblx0XHRcdFx0XHRwYXJlbnQgPSBhdG9tLnByb2plY3QucmVtb3RlZnRwLnJlc29sdmUoUGF0aC5kaXJuYW1lKHJlbW90ZSkucmVwbGFjZSgvXFxcXC9nLCAnLycpKTtcblx0XHRcdFx0aWYgKHBhcmVudClcblx0XHRcdFx0XHRwYXJlbnQub3BlbigpO1xuXHRcdFx0fSBjYXRjaCAoZSkge31cblx0XHR9KTtcblx0fVxufVxuIl19