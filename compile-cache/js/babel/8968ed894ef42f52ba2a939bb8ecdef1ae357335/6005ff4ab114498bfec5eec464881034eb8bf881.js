var __hasProp = ({}).hasOwnProperty,
    __extends = function __extends(child, parent) {
	for (var key in parent) {
		if (__hasProp.call(parent, key)) child[key] = parent[key];
	}function ctor() {
		this.constructor = child;
	}ctor.prototype = parent.prototype;child.prototype = new ctor();child.__super__ = parent.prototype;return child;
},
    $ = require('atom').$,
    FileView = require('./file-view'),
    View = require('atom').View;

module.exports = DirectoryView = (function (parent) {

	__extends(DirectoryView, parent);

	function DirectoryView() {
		DirectoryView.__super__.constructor.apply(this, arguments);
	}

	DirectoryView.content = function () {
		return this.li({
			'class': 'directory entry list-nested-item collapsed'
		}, (function () {
			this.div({
				'class': 'header list-item',
				'outlet': 'header'
			}, (function () {
				return this.span({
					'class': 'name icon',
					'outlet': 'name'
				});
			}).bind(this));
			this.ol({
				'class': 'entries list-tree',
				'outlet': 'entries'
			});
		}).bind(this));
	};

	DirectoryView.prototype.initialize = function (directory) {
		//DirectoryView.__super__.initialize.apply(this, arguments);

		var self = this;

		self.item = directory;
		self.name.text(self.item.name);
		self.name.attr('data-name', self.item.name);
		self.name.attr('data-path', self.item.remote);
		self.name.addClass(self.item.type && self.item.type == 'l' ? 'icon-file-symlink-directory' : 'icon-file-directory');

		if (self.item.isExpanded || self.item.isRoot) self.expand();

		// Trigger repaint
		self.item.$folders.onValue(function () {
			self.repaint();
		});
		self.item.$files.onValue(function () {
			self.repaint();
		});
		self.item.$isExpanded.onValue(function () {
			self.setClasses();
		});
		self.item.on('destroyed', function () {
			self.destroy();
		});
		self.repaint();

		// Events
		self.on('mousedown', function (e) {
			e.stopPropagation();

			var view = $(this).view(),
			    button = e.originalEvent ? e.originalEvent.button : 0;

			if (!view) return;

			switch (button) {
				case 2:
					if (view.is('.selected')) return;
				default:
					if (!e.ctrlKey) $('.remote-ftp-view .selected').removeClass('selected');
					view.toggleClass('selected');

					if (button == 0) {
						if (view.item.status == 0) view.open();

						if (button == 0) view.toggle();else view.expand();
					}
			}
		});
		self.on('dblclick', function (e) {
			e.stopPropagation();

			var view = $(this).view();
			if (!view) return;

			view.open();
		});
	};

	DirectoryView.prototype.destroy = function () {
		this.item = null;

		this.remove();
	};

	DirectoryView.prototype.repaint = function (recursive) {
		var self = this,
		    views = self.entries.children().map(function () {
			return $(this).view();
		}).get(),
		    folders = [],
		    files = [];

		self.entries.children().detach();

		self.item.folders.forEach(function (item) {
			for (var a = 0, b = views.length; a < b; ++a) if (views[a] && views[a] instanceof DirectoryView && views[a].item == item) {
				folders.push(views[a]);
				return;
			}
			folders.push(new DirectoryView(item));
		});
		self.item.files.forEach(function (item) {
			for (var a = 0, b = views.length; a < b; ++a) if (views[a] && views[a] instanceof FileView && views[a].item == item) {
				files.push(views[a]);
				return;
			}
			files.push(new FileView(item));
		});

		// TODO Destroy left over...

		views = folders.concat(files);

		views.sort(function (a, b) {
			if (a.constructor != b.constructor) return a instanceof DirectoryView ? -1 : 1;
			if (a.item.name == b.item.name) return 0;

			return a.item.name.toLowerCase().localeCompare(b.item.name.toLowerCase());
		});

		views.forEach(function (view) {
			self.entries.append(view);
		});
	};

	DirectoryView.prototype.setClasses = function () {
		if (this.item.isExpanded) {
			this.addClass('expanded').removeClass('collapsed');
		} else {
			this.addClass('collapsed').removeClass('expanded');
		}
	};

	DirectoryView.prototype.expand = function (recursive) {
		this.item.isExpanded = true;

		if (recursive) {
			this.entries.children().each(function () {
				var view = $(this).view();
				if (view && view instanceof DirectoryView) view.expand(true);
			});
		}
	};

	DirectoryView.prototype.collapse = function (recursive) {
		this.item.isExpanded = false;

		if (recursive) {
			this.entries.children().each(function () {
				var view = $(this).view();
				if (view && view instanceof DirectoryView) view.collapse(true);
			});
		}
	};

	DirectoryView.prototype.toggle = function (recursive) {
		if (this.item.isExpanded) this.collapse(recursive);else this.expand(recursive);
	};

	DirectoryView.prototype.open = function () {
		this.item.open();
	};

	DirectoryView.prototype.refresh = function () {
		this.item.open();
	};

	return DirectoryView;
})(View);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi9Vc2Vycy9uYXZlci8uYXRvbS9wYWNrYWdlcy9yZW1vdGUtZnRwL2xpYi92aWV3cy9kaXJlY3Rvcnktdmlldy5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxJQUFJLFNBQVMsR0FBRyxDQUFBLEdBQUUsQ0FBQyxjQUFjO0lBQ2hDLFNBQVMsR0FBRyxTQUFaLFNBQVMsQ0FBWSxLQUFLLEVBQUUsTUFBTSxFQUFFO0FBQUUsTUFBSyxJQUFJLEdBQUcsSUFBSSxNQUFNLEVBQUU7QUFBRSxNQUFJLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7RUFBRSxBQUFDLFNBQVMsSUFBSSxHQUFHO0FBQUUsTUFBSSxDQUFDLFdBQVcsR0FBRyxLQUFLLENBQUM7RUFBRSxBQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxBQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQyxBQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxBQUFDLE9BQU8sS0FBSyxDQUFDO0NBQUU7SUFDL1IsQ0FBQyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3JCLFFBQVEsR0FBRyxPQUFPLENBQUMsYUFBYSxDQUFDO0lBQ2pDLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxDQUFDOztBQUU3QixNQUFNLENBQUMsT0FBTyxHQUFHLGFBQWEsR0FBRyxDQUFDLFVBQVUsTUFBTSxFQUFFOztBQUVuRCxVQUFTLENBQUMsYUFBYSxFQUFFLE1BQU0sQ0FBQyxDQUFDOztBQUVqQyxVQUFTLGFBQWEsR0FBSTtBQUN6QixlQUFhLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLFNBQVMsQ0FBQyxDQUFDO0VB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QUUsQ0FBQztFQUNqQixDQUFBOztBQUVELGNBQWEsQ0FBQyxTQUFTLENBQUMsT0FBTyxHQUFHLFlBQVk7QUFDN0MsTUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztFQUNqQixDQUFBOztBQUVELFFBQU8sYUFBYSxDQUFDO0NBRXJCLENBQUEsQ0FBRSxJQUFJLENBQUMsQ0FBQyIsImZpbGUiOiIvVXNlcnMvbmF2ZXIvLmF0b20vcGFja2FnZXMvcmVtb3RlLWZ0cC9saWIvdmlld3MvZGlyZWN0b3J5LXZpZXcuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgX19oYXNQcm9wID0ge30uaGFzT3duUHJvcGVydHksXG5cdF9fZXh0ZW5kcyA9IGZ1bmN0aW9uKGNoaWxkLCBwYXJlbnQpIHsgZm9yICh2YXIga2V5IGluIHBhcmVudCkgeyBpZiAoX19oYXNQcm9wLmNhbGwocGFyZW50LCBrZXkpKSBjaGlsZFtrZXldID0gcGFyZW50W2tleV07IH0gZnVuY3Rpb24gY3RvcigpIHsgdGhpcy5jb25zdHJ1Y3RvciA9IGNoaWxkOyB9IGN0b3IucHJvdG90eXBlID0gcGFyZW50LnByb3RvdHlwZTsgY2hpbGQucHJvdG90eXBlID0gbmV3IGN0b3IoKTsgY2hpbGQuX19zdXBlcl9fID0gcGFyZW50LnByb3RvdHlwZTsgcmV0dXJuIGNoaWxkOyB9LFxuXHQkID0gcmVxdWlyZSgnYXRvbScpLiQsXG5cdEZpbGVWaWV3ID0gcmVxdWlyZSgnLi9maWxlLXZpZXcnKSxcblx0VmlldyA9IHJlcXVpcmUoJ2F0b20nKS5WaWV3O1xuXG5tb2R1bGUuZXhwb3J0cyA9IERpcmVjdG9yeVZpZXcgPSAoZnVuY3Rpb24gKHBhcmVudCkge1xuXG5cdF9fZXh0ZW5kcyhEaXJlY3RvcnlWaWV3LCBwYXJlbnQpO1xuXG5cdGZ1bmN0aW9uIERpcmVjdG9yeVZpZXcgKCkge1xuXHRcdERpcmVjdG9yeVZpZXcuX19zdXBlcl9fLmNvbnN0cnVjdG9yLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7XG5cdH1cblxuXHREaXJlY3RvcnlWaWV3LmNvbnRlbnQgPSBmdW5jdGlvbiAoKSB7XG5cdFx0cmV0dXJuIHRoaXMubGkoe1xuXHRcdFx0J2NsYXNzJzogJ2RpcmVjdG9yeSBlbnRyeSBsaXN0LW5lc3RlZC1pdGVtIGNvbGxhcHNlZCdcblx0XHR9LCBmdW5jdGlvbiAoKSB7XG5cdFx0XHR0aGlzLmRpdih7XG5cdFx0XHRcdCdjbGFzcyc6ICdoZWFkZXIgbGlzdC1pdGVtJyxcblx0XHRcdFx0J291dGxldCc6ICdoZWFkZXInXG5cdFx0XHR9LCBmdW5jdGlvbiAoKSB7XG5cdFx0XHRcdHJldHVybiB0aGlzLnNwYW4oe1xuXHRcdFx0XHRcdCdjbGFzcyc6ICduYW1lIGljb24nLFxuXHRcdFx0XHRcdCdvdXRsZXQnOiAnbmFtZSdcblx0XHRcdFx0fSlcblx0XHRcdH0uYmluZCh0aGlzKSk7XG5cdFx0XHR0aGlzLm9sKHtcblx0XHRcdFx0J2NsYXNzJzogJ2VudHJpZXMgbGlzdC10cmVlJyxcblx0XHRcdFx0J291dGxldCc6ICdlbnRyaWVzJ1xuXHRcdFx0fSk7XG5cdFx0fS5iaW5kKHRoaXMpKTtcblx0fTtcblxuXHREaXJlY3RvcnlWaWV3LnByb3RvdHlwZS5pbml0aWFsaXplID0gZnVuY3Rpb24gKGRpcmVjdG9yeSkge1xuXHRcdC8vRGlyZWN0b3J5Vmlldy5fX3N1cGVyX18uaW5pdGlhbGl6ZS5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuXG5cdFx0dmFyIHNlbGYgPSB0aGlzO1xuXG5cdFx0c2VsZi5pdGVtID0gZGlyZWN0b3J5O1xuXHRcdHNlbGYubmFtZS50ZXh0KHNlbGYuaXRlbS5uYW1lKTtcblx0XHRzZWxmLm5hbWUuYXR0cignZGF0YS1uYW1lJywgc2VsZi5pdGVtLm5hbWUpO1xuXHRcdHNlbGYubmFtZS5hdHRyKCdkYXRhLXBhdGgnLCBzZWxmLml0ZW0ucmVtb3RlKTtcblx0XHRzZWxmLm5hbWUuYWRkQ2xhc3Moc2VsZi5pdGVtLnR5cGUgJiYgc2VsZi5pdGVtLnR5cGUgPT0gJ2wnID8gJ2ljb24tZmlsZS1zeW1saW5rLWRpcmVjdG9yeScgOiAnaWNvbi1maWxlLWRpcmVjdG9yeScpXG5cblx0XHRpZiAoc2VsZi5pdGVtLmlzRXhwYW5kZWQgfHwgc2VsZi5pdGVtLmlzUm9vdClcblx0XHRcdHNlbGYuZXhwYW5kKCk7XG5cblx0XHQvLyBUcmlnZ2VyIHJlcGFpbnRcblx0XHRzZWxmLml0ZW0uJGZvbGRlcnMub25WYWx1ZShmdW5jdGlvbiAoKSB7IHNlbGYucmVwYWludCgpOyB9KTtcblx0XHRzZWxmLml0ZW0uJGZpbGVzLm9uVmFsdWUoZnVuY3Rpb24gKCkgeyBzZWxmLnJlcGFpbnQoKTsgfSk7XG5cdFx0c2VsZi5pdGVtLiRpc0V4cGFuZGVkLm9uVmFsdWUoZnVuY3Rpb24gKCkgeyBzZWxmLnNldENsYXNzZXMoKTsgfSk7XG5cdFx0c2VsZi5pdGVtLm9uKCdkZXN0cm95ZWQnLCBmdW5jdGlvbiAoKSB7IHNlbGYuZGVzdHJveSgpOyB9KTtcblx0XHRzZWxmLnJlcGFpbnQoKTtcblxuXHRcdC8vIEV2ZW50c1xuXHRcdHNlbGYub24oJ21vdXNlZG93bicsIGZ1bmN0aW9uIChlKSB7XG5cdFx0XHRlLnN0b3BQcm9wYWdhdGlvbigpO1xuXG5cdFx0XHR2YXIgdmlldyA9ICQodGhpcykudmlldygpLFxuXHRcdFx0XHRidXR0b24gPSBlLm9yaWdpbmFsRXZlbnQgPyBlLm9yaWdpbmFsRXZlbnQuYnV0dG9uIDogMDtcblxuXHRcdFx0aWYgKCF2aWV3KVxuXHRcdFx0XHRyZXR1cm47XG5cblx0XHRcdHN3aXRjaCAoYnV0dG9uKSB7XG5cdFx0XHRcdGNhc2UgMjpcblx0XHRcdFx0XHRpZiAodmlldy5pcygnLnNlbGVjdGVkJykpXG5cdFx0XHRcdFx0XHRyZXR1cm47XG5cdFx0XHRcdGRlZmF1bHQ6XG5cdFx0XHRcdFx0aWYgKCFlLmN0cmxLZXkpXG5cdFx0XHRcdFx0XHQkKCcucmVtb3RlLWZ0cC12aWV3IC5zZWxlY3RlZCcpLnJlbW92ZUNsYXNzKCdzZWxlY3RlZCcpO1xuXHRcdFx0XHRcdHZpZXcudG9nZ2xlQ2xhc3MoJ3NlbGVjdGVkJyk7XG5cblx0XHRcdFx0XHRpZiAoYnV0dG9uID09IDApIHtcblx0XHRcdFx0XHRcdGlmICh2aWV3Lml0ZW0uc3RhdHVzID09IDApXG5cdFx0XHRcdFx0XHRcdHZpZXcub3BlbigpO1xuXG5cdFx0XHRcdFx0XHRpZiAoYnV0dG9uID09IDApXG5cdFx0XHRcdFx0XHRcdHZpZXcudG9nZ2xlKCk7XG5cdFx0XHRcdFx0XHRlbHNlXG5cdFx0XHRcdFx0XHRcdHZpZXcuZXhwYW5kKCk7XG5cdFx0XHRcdFx0fVxuXHRcdFx0fVxuXHRcdH0pO1xuXHRcdHNlbGYub24oJ2RibGNsaWNrJywgZnVuY3Rpb24gKGUpIHtcblx0XHRcdGUuc3RvcFByb3BhZ2F0aW9uKCk7XG5cblx0XHRcdHZhciB2aWV3ID0gJCh0aGlzKS52aWV3KCk7XG5cdFx0XHRpZiAoIXZpZXcpXG5cdFx0XHRcdHJldHVybjtcblxuXHRcdFx0dmlldy5vcGVuKCk7XG5cdFx0fSk7XG5cdH1cblxuXHREaXJlY3RvcnlWaWV3LnByb3RvdHlwZS5kZXN0cm95ID0gZnVuY3Rpb24gKCkge1xuXHRcdHRoaXMuaXRlbSA9IG51bGw7XG5cblx0XHR0aGlzLnJlbW92ZSgpO1xuXHR9XG5cblx0RGlyZWN0b3J5Vmlldy5wcm90b3R5cGUucmVwYWludCA9IGZ1bmN0aW9uIChyZWN1cnNpdmUpIHtcblx0XHR2YXIgc2VsZiA9IHRoaXMsXG5cdFx0XHR2aWV3cyA9IHNlbGYuZW50cmllcy5jaGlsZHJlbigpLm1hcChmdW5jdGlvbiAoKSB7IHJldHVybiAkKHRoaXMpLnZpZXcoKTsgfSkuZ2V0KCksXG5cdFx0XHRmb2xkZXJzID0gW10sXG5cdFx0XHRmaWxlcyA9IFtdO1xuXG5cdFx0c2VsZi5lbnRyaWVzLmNoaWxkcmVuKCkuZGV0YWNoKCk7XG5cblx0XHRzZWxmLml0ZW0uZm9sZGVycy5mb3JFYWNoKGZ1bmN0aW9uIChpdGVtKSB7XG5cdFx0XHRmb3IgKHZhciBhID0gMCwgYiA9IHZpZXdzLmxlbmd0aDsgYSA8IGI7ICsrYSlcblx0XHRcdFx0aWYgKHZpZXdzW2FdICYmIHZpZXdzW2FdIGluc3RhbmNlb2YgRGlyZWN0b3J5VmlldyAmJiB2aWV3c1thXS5pdGVtID09IGl0ZW0pIHtcblx0XHRcdFx0XHRmb2xkZXJzLnB1c2godmlld3NbYV0pO1xuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXHRcdFx0Zm9sZGVycy5wdXNoKG5ldyBEaXJlY3RvcnlWaWV3KGl0ZW0pKTtcblx0XHR9KTtcblx0XHRzZWxmLml0ZW0uZmlsZXMuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkge1xuXHRcdFx0Zm9yICh2YXIgYSA9IDAsIGIgPSB2aWV3cy5sZW5ndGg7IGEgPCBiOyArK2EpXG5cdFx0XHRcdGlmICh2aWV3c1thXSAmJiB2aWV3c1thXSBpbnN0YW5jZW9mIEZpbGVWaWV3ICYmIHZpZXdzW2FdLml0ZW0gPT0gaXRlbSkge1xuXHRcdFx0XHRcdGZpbGVzLnB1c2godmlld3NbYV0pO1xuXHRcdFx0XHRcdHJldHVybjtcblx0XHRcdFx0fVxuXHRcdFx0ZmlsZXMucHVzaChuZXcgRmlsZVZpZXcoaXRlbSkpO1xuXHRcdH0pO1xuXG5cdFx0Ly8gVE9ETyBEZXN0cm95IGxlZnQgb3Zlci4uLlxuXG5cdFx0dmlld3MgPSBmb2xkZXJzLmNvbmNhdChmaWxlcyk7XG5cblx0XHR2aWV3cy5zb3J0KGZ1bmN0aW9uIChhLCBiKSB7XG5cdFx0XHRpZiAoYS5jb25zdHJ1Y3RvciAhPSBiLmNvbnN0cnVjdG9yKVxuXHRcdFx0XHRyZXR1cm4gYSBpbnN0YW5jZW9mIERpcmVjdG9yeVZpZXcgPyAtMSA6IDE7XG5cdFx0XHRpZiAoYS5pdGVtLm5hbWUgPT0gYi5pdGVtLm5hbWUpXG5cdFx0XHRcdHJldHVybiAwO1xuXG5cdFx0XHRyZXR1cm4gYS5pdGVtLm5hbWUudG9Mb3dlckNhc2UoKS5sb2NhbGVDb21wYXJlKGIuaXRlbS5uYW1lLnRvTG93ZXJDYXNlKCkpO1xuXHRcdH0pO1xuXG5cdFx0dmlld3MuZm9yRWFjaChmdW5jdGlvbiAodmlldykge1xuXHRcdFx0c2VsZi5lbnRyaWVzLmFwcGVuZCh2aWV3KTtcblx0XHR9KTtcblx0fVxuXG5cdERpcmVjdG9yeVZpZXcucHJvdG90eXBlLnNldENsYXNzZXMgPSBmdW5jdGlvbiAoKSB7XG5cdFx0aWYgKHRoaXMuaXRlbS5pc0V4cGFuZGVkKSB7XG5cdFx0XHR0aGlzLmFkZENsYXNzKCdleHBhbmRlZCcpLnJlbW92ZUNsYXNzKCdjb2xsYXBzZWQnKTtcblx0XHR9IGVsc2Uge1xuXHRcdFx0dGhpcy5hZGRDbGFzcygnY29sbGFwc2VkJykucmVtb3ZlQ2xhc3MoJ2V4cGFuZGVkJyk7XG5cdFx0fVxuXHR9XG5cblx0RGlyZWN0b3J5Vmlldy5wcm90b3R5cGUuZXhwYW5kID0gZnVuY3Rpb24gKHJlY3Vyc2l2ZSkge1xuXHRcdHRoaXMuaXRlbS5pc0V4cGFuZGVkID0gdHJ1ZTtcblxuXHRcdGlmIChyZWN1cnNpdmUpIHtcblx0XHRcdHRoaXMuZW50cmllcy5jaGlsZHJlbigpLmVhY2goZnVuY3Rpb24gKCkge1xuXHRcdFx0XHR2YXIgdmlldyA9ICQodGhpcykudmlldygpO1xuXHRcdFx0XHRpZiAodmlldyAmJiB2aWV3IGluc3RhbmNlb2YgRGlyZWN0b3J5Vmlldylcblx0XHRcdFx0XHR2aWV3LmV4cGFuZCh0cnVlKTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdERpcmVjdG9yeVZpZXcucHJvdG90eXBlLmNvbGxhcHNlID0gZnVuY3Rpb24gKHJlY3Vyc2l2ZSkge1xuXHRcdHRoaXMuaXRlbS5pc0V4cGFuZGVkID0gZmFsc2U7XG5cblx0XHRpZiAocmVjdXJzaXZlKSB7XG5cdFx0XHR0aGlzLmVudHJpZXMuY2hpbGRyZW4oKS5lYWNoKGZ1bmN0aW9uICgpIHtcblx0XHRcdFx0dmFyIHZpZXcgPSAkKHRoaXMpLnZpZXcoKTtcblx0XHRcdFx0aWYgKHZpZXcgJiYgdmlldyBpbnN0YW5jZW9mIERpcmVjdG9yeVZpZXcpXG5cdFx0XHRcdFx0dmlldy5jb2xsYXBzZSh0cnVlKTtcblx0XHRcdH0pO1xuXHRcdH1cblx0fVxuXG5cdERpcmVjdG9yeVZpZXcucHJvdG90eXBlLnRvZ2dsZSA9IGZ1bmN0aW9uIChyZWN1cnNpdmUpIHtcblx0XHRpZiAodGhpcy5pdGVtLmlzRXhwYW5kZWQpXG5cdFx0XHR0aGlzLmNvbGxhcHNlKHJlY3Vyc2l2ZSk7XG5cdFx0ZWxzZVxuXHRcdFx0dGhpcy5leHBhbmQocmVjdXJzaXZlKTtcblx0fVxuXG5cdERpcmVjdG9yeVZpZXcucHJvdG90eXBlLm9wZW4gPSBmdW5jdGlvbiAoKSB7XG5cdFx0dGhpcy5pdGVtLm9wZW4oKTtcblx0fVxuXG5cdERpcmVjdG9yeVZpZXcucHJvdG90eXBlLnJlZnJlc2ggPSBmdW5jdGlvbiAoKSB7XG5cdFx0dGhpcy5pdGVtLm9wZW4oKTtcblx0fVxuXG5cdHJldHVybiBEaXJlY3RvcnlWaWV3O1xuXG59KShWaWV3KTtcbiJdfQ==